<!DOCTYPE html>
<html lang="he"> <!-- The dir will be set by JavaScript -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle"> SentiVest</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 住驻转 住驻专转 Font Awesome 拽 住驻  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- TradingView Widget Script - REMOVED from here, will be injected dynamically -->

    <style>
        /* CSS Variables for theming */
        :root {
            /* Light Mode Defaults */
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --login-box-bg: rgba(255, 255, 255, 0.95);
            --text-color-primary: #1f2937;
            --text-color-secondary: #4b5563;
            --disclaimer-bg: #f8fafc;
            --disclaimer-border: #e2e8f0;
            --input-border: #e2e8f0;
            --input-focus-border: #3b82f6;
            --container-bg: rgba(255, 255, 255, 0.95);
            --card-bg: white;
            --card-border: #e2e8f0;
            --selected-card-bg-start: #e9fff0; /* Brighter light green */
            --selected-card-bg-end: #d9ffe6;   /* Brighter light green */
            --selected-card-border: #10b981;   /* Initial Green border */
            --selected-card-border-strong: #008000; /* Stronger Dark Green border for selected */
            --selected-card-shadow-strong-start: rgba(0, 128, 0, 0.4); /* Green shadow start */
            --selected-card-shadow-strong-end: rgba(0, 128, 0, 0.6);   /* Green shadow end */
            --stock-chip-bg: #f1f5f9;
            --stock-chip-color: #475569;
            --stock-chip-border: #e2e8f0;
            --selected-stock-chip-bg: #c8ffe0; /* Lighter green for selected chips */
            --selected-stock-chip-color: #005000; /* Darker green for selected chips text */
            --selected-stock-chip-border: #008000; /* Stronger green for selected chips border */
            --selection-summary-bg-start: #f8fafc;
            --selection-summary-bg-end: #f1f5f9;
            --selection-summary-border: #e2e8f0;
            --footer-bg: #f8fafc;
            --footer-color: #6b7280;
            --analysis-card-bg: white;
            --analysis-card-border: #e5e7eb;
            --analysis-card-hover-shadow: rgba(0,0,0,0.15);
            --technical-analysis-bg: #f8fafc;
            --news-sentiment-bg: #f8fafc;
            --news-sentiment-border: #e2e8f0;
            --sentiment-link-hover-bg: #eef2ff;
            --chart-container-bg: white;
            --skeleton-color-light: #e0e0e0;
            --skeleton-color-dark: #f0f0f0;
            --ai-insight-bg: #e0f2fe;
            --ai-insight-border-left: #3b82f6;
            --ai-insight-text-color: #1e3a8a;
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #0f0f1c;
            --login-box-bg: rgba(30, 30, 40, 0.95);
            --text-color-primary: #f0f0f0;
            --text-color-secondary: #a0a0a0;
            --disclaimer-bg: #2a2a3a;
            --disclaimer-border: #3a3a4a;
            --input-border: #4a4a5a;
            --input-focus-border: #60a5fa;
            --container-bg: rgba(30, 30, 40, 0.95);
            --card-bg: #2a2a3a;
            --card-border: #3a3a4a;
            --selected-card-bg-start: #0a2e1d; /* Darker, slightly desaturated green */
            --selected-card-bg-end: #082418;   /* Darker, slightly desaturated green */
            --selected-card-border: #059669;   /* Initial Darker green border */
            --selected-card-border-strong: #32CD32; /* Stronger Lime Green border for selected */
            --selected-card-shadow-strong-start: rgba(50, 205, 50, 0.4); /* Lime green shadow start */
            --selected-card-shadow-strong-end: rgba(50, 205, 50, 0.6);   /* Lime green shadow end */
            --stock-chip-bg: #3a3a4a;
            --stock-chip-color: #b0b0b0;
            --stock-chip-border: #4a4a5a;
            --selected-stock-chip-bg: #0d4a30; /* Darker green for selected chips */
            --selected-stock-chip-color: #dcfce7; /* Lighter text for selected chips */
            --selected-stock-chip-border: #006400; /* Stronger green for selected chips border */
            --selection-summary-bg-start: #1a1a2e;
            --selection-summary-bg-end: #0f0f1c;
            --selection-summary-border: #2a2a3a;
            --footer-bg: #1a1a2e;
            --footer-color: #a0a0a0;
            --analysis-card-bg: #2a2a3a;
            --analysis-card-border: #3a3a4a;
            --analysis-card-hover-shadow: rgba(255,255,255,0.08);
            --technical-analysis-bg: #2a2a3a;
            --news-sentiment-bg: #2a2a3a;
            --news-sentiment-border: #3a3a4a;
            --sentiment-link-hover-bg: #3a3a4a;
            --chart-container-bg: #2a2a3a;
            --skeleton-color-light: #3a3a4a;
            --skeleton-color-dark: #4a4a5a;
            --ai-insight-bg: #1a1a2e;
            --ai-insight-border-left: #60a5fa;
            --ai-insight-text-color: #90c0ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            overflow-x: hidden; /* 注  驻拽转 转专转 */
            color: var(--text-color-primary); /* Default text color for body */
            transition: background 0.5s ease-in-out, color 0.5s ease-in-out;
        }
        
        /* Login Page Styles */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
            transition: background 0.5s ease-in-out;
        }

        .login-box {
            background: var(--login-box-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
            animation: fadeIn 0.5s ease-in-out;
            position: relative; /* 注专 驻拽 砖 */
            overflow: hidden; /* 注专 驻拽 拽拽 */
            z-index: 1; /* Ensure content is above particles */
            transition: background 0.5s ease-in-out;
        }

        /* Particles effect for login box background */
        .login-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(255,255,255,0.05) 10%, transparent 70%);
            animation: particleAnimation 15s infinite linear;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes particleAnimation {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.5) rotate(180deg); opacity: 0.2; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .login-box h1 {
            font-size: 2em;
            margin-bottom: 10px;
            color: var(--text-color-primary);
            position: relative; /* For z-index */
            z-index: 1;
            transition: color 0.5s ease-in-out;
        }
        
        .login-box .tagline {
            font-size: 1.1em;
            color: var(--text-color-secondary);
            margin-bottom: 25px; /* Adjust spacing after tagline */
            position: relative;
            z-index: 1;
            transition: color 0.5s ease-in-out;
        }

        .login-box p {
            font-size: 1.1em;
            color: var(--text-color-secondary);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            transition: color 0.5s ease-in-out;
        }

        .disclaimer {
            background-color: var(--disclaimer-bg);
            border: 1px solid var(--disclaimer-border);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0 30px 0;
            text-align: right; /* Default for RTL */
            position: relative;
            z-index: 1;
            transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }

        html[dir="ltr"] .disclaimer {
            text-align: left;
        }

        .disclaimer h3 {
            font-size: 1.1em;
            color: var(--text-color-primary);
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
            transition: color 0.5s ease-in-out;
        }

        .disclaimer p {
            font-size: 0.9em;
            color: var(--text-color-secondary);
            line-height: 1.6;
            margin-bottom: 8px;
            transition: color 0.5s ease-in-out;
        }

        .disclaimer p:last-child {
            margin-bottom: 0;
        }
        
        /* New style for the added benefits text */
        .disclaimer .benefits-text {
            font-size: 0.95em;
            color: var(--text-color-secondary);
            margin-top: 15px;
            margin-bottom: 15px; /* Spacing before confirmation */
            font-weight: 500;
            transition: color 0.5s ease-in-out;
        }

        .disclaimer .confirmation-text {
            margin-top: 15px;
            font-weight: 500;
            transition: color 0.5s ease-in-out;
        }

        #usernameInput {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 20px;
            text-align: center;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.5s ease-in-out, color 0.5s ease-in-out;
            position: relative;
            z-index: 1;
            background-color: var(--card-bg); /* Use card-bg for input to adapt to dark mode */
            color: var(--text-color-primary);
        }

        #usernameInput:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); /* 驻拽 专 驻拽住 */
        }

        #startButton {
            width: 100%;
            position: relative;
            z-index: 1;
        }

        /* Styling for the original emoji logo */
        .login-logo {
            font-size: 2.5em; /* Bigger size for the emoji logo */
            margin-bottom: 20px;
            animation: bounceIn 0.8s ease-out;
            color: var(--text-color-primary); /* Ensure text color adapts */
            transition: color 0.5s ease-in-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            80% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }


        .body-container {
             padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: background 0.5s ease-in-out;
        }

        /* 注 专转 转 */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }

        .header {
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative; /* 注专 驻拽 住驻 */
            overflow: hidden;
        }

        /* Animated background for header */
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(60deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(255,255,255,0.1) 100%);
            transform: rotate(30deg);
            animation: headerSparkle 8s infinite linear;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes headerSparkle {
            0% { transform: rotate(0deg) translateX(-50%); }
            100% { transform: rotate(360deg) translateX(50%); }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #90f566);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
            /* 住驻转 爪 转专转 */
            animation: textPop 0.8s ease-out forwards;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        .market-ticker {
            background: #0f172a;
            color: white;
            padding: 15px;
            overflow: hidden;
            white-space: nowrap;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .ticker-content {
            display: inline-block;
            animation: scroll 30s linear infinite;
        }
        /* 住驻转 驻拽 专 拽 拽专 */
        .ticker-content span {
            margin-left: 30px;
            font-weight: bold;
            display: inline-block;
            position: relative;
            padding: 0 5px;
        }
        .ticker-content span::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -3px;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #00d4ff, #90f566);
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.5s ease-out;
        }
        .ticker-content span:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .main-content {
            padding: 40px;
        }

        .intro-text {
            text-align: center;
            margin-bottom: 40px;
            font-size: 1.1em;
            color: var(--text-color-secondary);
            line-height: 1.8;
            transition: color 0.5s ease-in-out;
        }
        /* 住驻转 爪 拽 拽住 驻转 */
        .intro-text strong {
            display: block;
            margin-bottom: 10px;
            animation: slideInFromTop 0.6s ease-out;
        }
        @keyframes slideInFromTop {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }


        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .category-card {
            border: 2px solid var(--card-border);
            border-radius: 15px;
            padding: 25px;
            background: var(--card-bg);
            transition: all 0.3s ease, transform 0.2s ease-out, box-shadow 0.2s ease-out, background 0.5s ease-in-out, border-color 0.5s ease-in-out;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            /* 住驻转 爪 拽 住 */
            transform: translateY(20px);
            opacity: 0;
            animation: cardAppear 0.5s ease-out forwards;
        }
        /* Animation delay for each card */
        .category-card:nth-child(1) { animation-delay: 0.1s; }
        .category-card:nth-child(2) { animation-delay: 0.2s; }
        .category-card:nth-child(3) { animation-delay: 0.3s; }
        .category-card:nth-child(4) { animation-delay: 0.4s; }
        .category-card:nth-child(5) { animation-delay: 0.5s; }
        .category-card:nth-child(6) { animation-delay: 0.6s; }
        .category-card:nth-child(7) { animation-delay: 0.7s; }
        .category-card:nth-child(8) { animation-delay: 0.8s; }
        .category-card:nth-child(9) { animation-delay: 0.9s; }
        .category-card:nth-child(10) { animation-delay: 1.0s; }
        .category-card:nth-child(11) { animation-delay: 1.1s; }
        .category-card:nth-child(12) { animation-delay: 1.2s; }
        .category-card:nth-child(13) { animation-delay: 1.3s; }
        .category-card:nth-child(14) { animation-delay: 1.4s; }
        .category-card:nth-child(15) { animation-delay: 1.5s; }
        .category-card:nth-child(16) { animation-delay: 1.6s; }
        
        @keyframes cardAppear {
            to { transform: translateY(0); opacity: 1; }
        }

        .category-card:hover {
            transform: translateY(-8px) scale(1.02); /* 转 驻拽 专祝  */
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); /* 爪 注拽 转专 专祝 */
            border-color: var(--input-focus-border); /* Changed to use variable */
        }

        /* * IMPORTANT: THIS IS THE CSS THAT MAKES THE SELECTED CARD HAVE A GREEN BORDER AND STAY VISIBLE.
         * The card DOES NOT disappear. It visually changes to indicate selection.
         */
        .category-card.selected {
            border: 5px solid var(--selected-card-border-strong); /* Thick and strong green border */
            background: linear-gradient(45deg, var(--selected-card-bg-start), var(--selected-card-bg-end));
            transform: translateY(-5px); /* Lift more to emphasize selection */
            box-shadow: 0 0 25px var(--selected-card-shadow-strong); /* Stronger green glow */
            animation: selectedPulse 0.8s ease-in-out infinite alternate; /* Continuous pulsing animation */
        }
        @keyframes selectedPulse {
            0% { transform: scale(1) translateY(-5px); box-shadow: 0 0 25px var(--selected-card-shadow-strong-start); }
            100% { transform: scale(1.01) translateY(-7px); box-shadow: 0 0 35px var(--selected-card-shadow-strong-end); }
        }

        .category-card.hot::before {
            content: " HOT!";
            position: absolute;
            top: 5px; /* Adjust top position */
            right: 5px; /* Always on the right for both LTR and RTL */
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            animation: pulse 2s infinite;
            z-index: 2; /*  砖 注 专拽注 驻拽 */
        }
        /* Removed LTR/RTL specific overrides for left/right to ensure it's always on the right */

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
        }
        
        @keyframes skeleton-pulse {
            0%, 100% { background-color: var(--skeleton-color-light); }
            50% { background-color: var(--skeleton-color-dark); }
        }


        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        html[dir="rtl"] .category-header {
            flex-direction: row-reverse; /* Icons on the right for RTL */
        }

        .category-icon {
            font-size: 2em;
            margin-left: 15px; /* Space from text in RTL */
            transition: transform 0.3s ease-out; /* 爪 拽 */
        }
        html[dir="ltr"] .category-icon {
            margin-left: 0;
            margin-right: 15px; /* Space from text in LTR */
        }

        .category-card:hover .category-icon {
            transform: rotate(10deg) scale(1.1); /* 住 拽  专祝 */
        }

        .category-title {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--text-color-primary);
            transition: color 0.5s ease-in-out;
        }

        .category-description {
            color: var(--text-color-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
            transition: color 0.5s ease-in-out;
        }

        .stocks-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .stock-chip {
            background: var(--stock-chip-bg);
            color: var(--stock-chip-color);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            border: 1px solid var(--stock-chip-border);
            transition: all 0.2s ease, background-color 0.5s ease-in-out, color 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }
        .stock-chip:hover {
            background-color: var(--disclaimer-border); /* Reusing a variable that fits for hover */
            color: var(--text-color-primary);
        }

        .category-card.selected .stock-chip {
            background: var(--selected-stock-chip-bg);
            color: var(--selected-stock-chip-color);
            border-color: var(--selected-stock-chip-border);
        }

        .trend-info {
            font-size: 0.9em;
            color: #059669; /* This color might need to be adjusted for dark mode if it's too bright */
            font-weight: 500;
            font-style: italic;
            border-top: 1px dashed var(--disclaimer-border);
            padding-top: 10px;
            margin-top: 10px;
            animation: slideInFromBottom 0.5s ease-out forwards; /* 爪 注  */
        }
        @keyframes slideInFromBottom {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .selection-summary {
            background: linear-gradient(45deg, var(--selection-summary-bg-start), var(--selection-summary-bg-end));
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 30px;
            border: 2px solid var(--selection-summary-border);
            /* 住驻转 爪 爪 */
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            transition: all 0.3s ease, background 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }
        .selection-summary:hover {
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }

        .selected-count {
            font-size: 2.5em; /*  拽 */
            font-weight: bold;
            color: #10b981;
            margin-bottom: 10px;
            transition: all 0.3s ease-out; /* 爪 住驻专 */
        }
        /* 爪 砖砖转 住驻专 */
        .selected-count.animate {
            animation: countChange 0.3s ease-out;
        }
        @keyframes countChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: #0f9f75; }
            100% { transform: scale(1); color: #10b981; }
        }


        .continue-btn {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .continue-btn:hover {
            transform: translateY(-5px) scale(1.02); /*  拽 驻拽 专祝 */
            box-shadow: 0 15px 35px rgba(16, 185, 129, 0.6); /* 爪 拽 转专 */
        }
        /* 驻拽  专 爪 */
        .continue-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: width 0.4s ease-out, height 0.4s ease-out, top 0.4s ease-out, left 0.4s ease-out;
            transform: translate(-50%, -50%);
            z-index: -1;
        }

        .continue-btn:hover::before {
            width: 200%;
            height: 200%;
        }

        .continue-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Dark/Light Mode Buttons */
        .theme-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .theme-button {
            padding: 10px 20px;
            border: 2px solid var(--input-border);
            border-radius: 25px;
            background-color: var(--card-bg);
            color: var(--text-color-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease, background-color 0.5s ease-in-out, color 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }

        .theme-button:hover {
            background-color: var(--disclaimer-border);
            border-color: var(--input-focus-border);
        }
        
        .theme-button.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }

        /* Language Switcher Styles - Each button positioned independently */
        #lang-en {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: var(--card-bg); /* Use card-bg for button background */
            border: 2px solid var(--input-border);
            color: var(--text-color-primary); /* Default text color */
            width: 45px; /* Fixed width for circular button */
            height: 45px; /* Fixed height for circular button */
            border-radius: 50%; /* Make it circular */
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease, background-color 0.5s ease-in-out, color 0.5s ease-in-out, border-color 0.5s ease-in-out;
            font-size: 0.9em;
            display: flex; /* Use flex to center text */
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Add shadow */
            z-index: 10000; /* Ensure it's above other elements */
        }

        #lang-he {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--card-bg); /* Use card-bg for button background */
            border: 2px solid var(--input-border);
            color: var(--text-color-primary); /* Default text color */
            width: 45px; /* Fixed width for circular button */
            height: 45px; /* Fixed height for circular button */
            border-radius: 50%; /* Make it circular */
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease, background-color 0.5s ease-in-out, color 0.5s ease-in-out, border-color 0.5s ease-in-out;
            font-size: 0.9em;
            display: flex; /* Use flex to center text */
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Add shadow */
            z-index: 10000; /* Ensure it's above other elements */
        }

        body.dark-mode .lang-button:hover {
            background-color: var(--disclaimer-border);
        }

        .lang-button.active {
            background: linear-gradient(45deg, #3b82f6, #60a5fa);
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }


        /* 注 转 */
        .analysis-header {
            background: linear-gradient(135deg, #1e3a8a, #3730a3);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        /* 爪转 专拽注 转专转 转 */
        .analysis-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.05) 10%, transparent 60%);
            animation: headerRadial 10s infinite alternate;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes headerRadial {
            0% { transform: scale(1); opacity: 0.1; }
            100% { transform: scale(1.2); opacity: 0.2; }
        }


        .analysis-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .market-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: slideInUp 0.8s ease-out; /* 爪 住 */
        }

        @keyframes slideInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }


        .market-card {
            background: var(--analysis-card-bg);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease, background-color 0.5s ease-in-out;
        }

        .market-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px var(--analysis-card-hover-shadow); /* Changed for dark mode */
        }

        .market-index {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-color-primary);
            margin-bottom: 5px;
            transition: color 0.5s ease-in-out;
        }

        .market-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
            /* 住驻转 爪 拽 砖 注专 */
            transition: color 0.3s ease-in-out;
        }

        .market-change {
            font-size: 0.9em;
            font-weight: bold;
            /* 住驻转 爪 拽 砖 */
            transition: color 0.3s ease-in-out;
        }

        .positive { color: #10b981; }
        .negative { color: #ef4444; }

        .selected-sectors {
            background: var(--card-bg); /* Reusing card-bg for consistency */
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            /* 爪 住 住拽专 */
            /* opacity: 0; */ /* REMOVED THIS LINE */
            /* transform: translateY(20px); */ /* REMOVED THIS LINE */
            animation: sectionFadeIn 0.8s ease-out forwards;
            animation-delay: 0.5s; /* 注 拽 专 -market-overview */
            transition: background 0.5s ease-in-out;
        }

        @keyframes sectionFadeIn {
            from { opacity: 0; transform: translateY(20px); } /* Start from hidden/lower */
            to { opacity: 1; transform: translateY(0); }
        }

        .sector-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-color-primary);
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--disclaimer-border); /* Reusing for a consistent line */
            transition: color 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }

        .stocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .stock-card {
            border: 1px solid var(--analysis-card-border);
            border-radius: 10px;
            padding: 20px;
            background: var(--disclaimer-bg); /* Lighter background for individual stock cards */
            transition: all 0.3s ease, background-color 0.5s ease-in-out, border-color 0.5s ease-in-out;
            position: relative;
            overflow: hidden;
            /* 爪 住 专住 转 */
            /* opacity: 0; */ /* REMOVED THIS LINE */
            /* transform: scale(0.9); */ /* REMOVED THIS LINE */
            animation: stockCardFadeIn 0.5s ease-out forwards;
        }
        /* 爪转 注  专住  */
        .stock-card:nth-child(1) { animation-delay: 0.1s; }
        .stock-card:nth-child(2) { animation-delay: 0.2s; }
        .stock-card:nth-child(3) { animation-delay: 0.3s; }
        .stock-card:nth-child(4) { animation-delay: 0.4s; }
        .stock-card:nth-child(5) { animation-delay: 0.5s; }
        /*    专住 住祝 */
        @keyframes stockCardFadeIn {
            from { opacity: 0; transform: scale(0.9); } /* Start from hidden/scaled down */
            to { transform: scale(1); opacity: 1; }
        }


        .stock-card:hover {
            transform: translateY(-5px) scale(1.01); /* 驻拽 专祝 注 转专 */
            box-shadow: 0 10px 25px var(--analysis-card-hover-shadow); /* 爪 拽 转专 */
        }
        /* 驻拽  专 注专 注专 */
        .stock-card:hover .stock-price {
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--disclaimer-border); /* Reusing for consistency */
            padding-bottom: 10px;
            transition: border-color 0.5s ease-in-out;
        }

        .stock-symbol {
            font-size: 1.3em; /*  拽 */
            font-weight: bold;
            color: var(--text-color-primary);
            transition: color 0.3s ease;
        }

        .stock-symbol:hover {
            color: #3b82f6; /* 砖 爪注 专祝 */
        }


        .stock-name {
            font-size: 0.9em;
            color: var(--text-color-secondary);
            transition: color 0.5s ease-in-out;
        }

        .stock-price {
            font-size: 1.4em; /*  拽 */
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .stock-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--disclaimer-border); /* Reusing for consistency */
            padding-bottom: 15px;
            transition: border-color 0.5s ease-in-out;
        }

        .stock-detail {
            display: flex;
            justify-content: space-between;
            align-items: center; /* 砖专  */
            font-size: 0.9em; /*  拽 */
        }

        .detail-label {
            color: var(--text-color-secondary);
            transition: color 0.5s ease-in-out;
        }

        .detail-value {
            font-weight: 500;
            color: var(--text-color-primary);
            transition: color 0.5s ease-in-out;
        }

        .technical-analysis {
            background: var(--technical-analysis-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--disclaimer-border); /* 住专转 拽 */
            transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }

        .technical-title {
            font-weight: bold;
            color: var(--text-color-primary);
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px dashed var(--disclaimer-border);
            padding-bottom: 8px;
            transition: color 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }

        .technical-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .sentiment-analysis {
            margin-top: 15px;
        }

        .sentiment-title { /* Can be reused for line chart title */
            font-weight: bold;
            color: var(--text-color-primary);
            margin-bottom: 10px;
            text-align: center;
            transition: color 0.5s ease-in-out;
        }
        
        .chart-container {
            position: relative;
            margin: auto;
            height: 200px; 
            width: 100%;
            margin-bottom: 15px;
            /* 住驻转 爪 注 转专砖 */
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 5px; /* 驻 拽 专 转专砖 住专转 */
            background-color: var(--chart-container-bg); /* 专拽注  转专砖 */
            transition: background-color 0.5s ease-in-out;
        }
        
        .line-chart-container { /* Specific container for line chart if needed */
            position: relative;
            margin: auto;
            height: 150px; /* Potentially different height */
            width: 100%;
            margin-top: 10px; /* Space above line chart */
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 5px;
            background-color: var(--chart-container-bg);
            transition: background-color 0.5s ease-in-out;
        }
        
        /* New styles for news sentiment analysis */
        .news-sentiment-analysis {
            background: var(--news-sentiment-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-top: 1px solid var(--analysis-card-border);
            border: 1px solid var(--news-sentiment-border); /* 住专转 拽 */
            transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }

        .news-sentiment-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .sentiment-link {
            text-decoration: none;
            color: inherit;
            display: block;
            border-radius: 6px;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease; /* 爪 专祝 */
            padding: 6px 8px; /* 驻  爪 */
            margin: -4px;
        }
        
    .sentiment-link:hover {
            background-color: var(--sentiment-link-hover-bg);
            transform: translateX(-5px); /* 转 拽 爪 专祝 */
        }
        html[dir="ltr"] .sentiment-link:hover {
            transform: translateX(5px); /* Move right for LTR */
        }

        .sentiment-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.88em; /*  拽 */
            color: var(--text-color-primary); /* 爪注 拽住  转专 */
            transition: color 0.5s ease-in-out;
        }
        html[dir="rtl"] .sentiment-detail {
            flex-direction: row-reverse; /* For RTL, icon on the right */
        }


        .sentiment-icon {
            font-size: 1.2em; /*  拽 砖 拽 */
            color: #3b82f6; /* 爪注  拽 */
        }

        .sentiment-detail .detail-value {
            font-weight: bold;
        }

        .sentiment-detail .detail-label {
            flex-grow: 1;
        }

        .overall-sentiment {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed var(--disclaimer-border);
            font-size: 0.9em;
            transition: border-color 0.5s ease-in-out;
        }

        .overall-sentiment .detail-label {
            font-weight: bold;
            color: var(--text-color-primary);
            transition: color 0.5s ease-in-out;
        }


        .sentiment-badge {
            padding: 6px 12px; /* 驻  转专 */
            border-radius: 20px;
            font-size: 0.85em; /*  驻 拽爪转 转专  */
            font-weight: bold;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* 爪 注 */
        }

        .sentiment-badge.positive { background-color: #10b981; }
        .sentiment-badge.negative { background-color: #ef4444; }
        .sentiment-badge.neutral { background-color: #6b7280; }

        /* Styles for info icon and tooltip */
        .sentiment-title-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px; /* Overrides .sentiment-title margin */
        }

        .info-icon {
            background-color: var(--disclaimer-border); /* Reusing a theme variable */
            color: var(--text-color-secondary); /* Reusing a theme variable */
            width: 24px; /* 转 拽 */
            height: 24px; /*  砖 拽 */
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-style: normal;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, color 0.5s ease-in-out;
            font-size: 0.9em; /*  拽 */
        }

        .info-icon:hover {
            background-color: var(--stock-chip-color); /* Darker shade of previous variable */
            transform: scale(1.1); /* 驻拽 拽驻爪 拽 */
        }

        .info-tooltip {
            visibility: hidden;
            opacity: 0;
            width: 280px;
            background-color: var(--text-color-primary); /* Use primary text color for tooltip bg */
            color: var(--card-bg); /* Use card-bg for tooltip text to ensure contrast */
            text-align: right; /* Default for RTL */
            border-radius: 8px; /* 驻转 注转 转专 */
            padding: 15px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the icon */
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); /* 爪 拽 转专 */
            transition: opacity 0.3s ease, visibility 0.3s ease, bottom 0.3s ease, background-color 0.5s ease-in-out, color 0.5s ease-in-out; /* Add transitions */
            font-size: 0.88em; /*  驻 拽爪转 转专  */
            line-height: 1.6;
        }
        html[dir="ltr"] .info-tooltip {
            text-align: left;
        }

        .info-tooltip::after { /* Tooltip arrow */
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -8px; /* 转  抓 */
            border-width: 8px; /*  抓 */
            border-style: solid;
            border-color: var(--text-color-primary) transparent transparent transparent; /* Arrow color matches tooltip bg */
            transition: border-color 0.5s ease-in-out; /* Add transition */
        }

        .info-tooltip p {
            margin-bottom: 10px;
        }

        .info-tooltip p:last-child {
            margin-bottom: 0;
        }

        .info-tooltip p strong {
            color: #60a5fa;
        }


        .sentiment-title-container:hover .info-tooltip {
            visibility: visible;
            opacity: 1;
            bottom: 140%; /* 转 拽 注 驻注 */
        }


        .back-btn {
            background: linear-gradient(45deg, #6b7280, #4b5563);
            color: white;
            padding: 10px 25px; /* 驻 拽爪转 转专  */
            border: none;
            border-radius: 25px;
            font-size: 1em; /*  驻 拽爪转 转专  */
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* 爪 拽 转专 */
        }

        .back-btn:hover {
            transform: translateY(-3px) scale(1.01); /* 驻拽 专祝 拽 */
            box-shadow: 0 8px 20px rgba(107, 114, 128, 0.5); /* 爪 拽 转专 */
        }

        .footer {
            background: var(--footer-bg);
            padding: 20px;
            text-align: center;
            color: var(--footer-color);
            font-size: 0.9em;
            border-top: 1px solid var(--disclaimer-border);
            transition: background-color 0.5s ease-in-out, color 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }

        /* Skeleton Loader Styles */
        .skeleton-card {
            border: 1px solid var(--analysis-card-border);
            border-radius: 10px;
            padding: 20px;
            background: var(--disclaimer-bg);
            transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }

        .skeleton-item {
            background-color: var(--skeleton-color-light);
            border-radius: 4px;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
            transition: background-color 0.5s ease-in-out;
        }

        .skeleton-header-top { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .skeleton-symbol-name { width: 40%; height: 20px; margin-bottom: 5px; }
        .skeleton-name-small { width: 60%; height: 16px; }
        .skeleton-price-area { width: 30%; height: 30px; }

        .skeleton-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .skeleton-detail-item { height: 16px; }

        .skeleton-tech-title { width: 70%; height: 20px; margin-bottom: 10px; }
        .skeleton-tech-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .skeleton-tech-item { height: 16px; }

        .skeleton-news-title { width: 80%; height: 20px; margin: 15px 0 10px 0; }
        .skeleton-news-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .skeleton-news-item { height: 18px; }

        .skeleton-overall-sentiment { height: 24px; width: 60%; margin-top: 15px; }


        .skeleton-chart-title { width: 60%; height: 20px; margin: 15px auto 10px auto; }
        .skeleton-chart-doughnut { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 15px auto; }
        .skeleton-chart-line { width: 100%; height: 120px; margin-bottom: 15px; }

        /* New AI Insight styles */
        .ai-insight {
            background: var(--ai-insight-bg);
            border-left: 5px solid var(--ai-insight-border-left);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px; /* Space above */
            margin-bottom: 15px; /* Space below */
            font-size: 0.95em;
            line-height: 1.6;
            color: var(--ai-insight-text-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Subtle shadow */
            transition: all 0.3s ease-in-out, background-color 0.5s ease-in-out, border-color 0.5s ease-in-out, color 0.5s ease-in-out;
            position: relative; /* For icon */
        }
        html[dir="ltr"] .ai-insight {
            border-left: none;
            border-right: 5px solid var(--ai-insight-border-left);
        }

        .ai-insight strong {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
            color: var(--text-color-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.5s ease-in-out;
        }
        html[dir="rtl"] .ai-insight strong {
            flex-direction: row-reverse;
        }


        .ai-insight strong i {
            color: var(--ai-insight-border-left); /* Icon color */
            font-size: 1.2em;
        }
        
        /* AI Loading dots */
        .ai-insight .loading-dots span {
            animation: blink 1.4s infinite linear;
        }

        .ai-insight .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .ai-insight .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .body-container {
                padding: 10px; /* Reduced padding for smaller screens */
            }
            .header {
                padding: 20px; /* Reduced padding */
            }
            .header h1, .analysis-header h1 {
                font-size: 1.8em; /* Smaller font for headers */
            }
            .header p {
                font-size: 1em; /* Smaller font for header description */
                line-height: 1.5;
            }
            .analysis-header {
                padding: 20px; /* Reduced padding */
            }
            .analysis-header p {
                font-size: 0.9em; /* Smaller font for analysis header description */
            }

            .main-content {
                padding: 15px; /* Reduced padding for main content area */
            }
            .intro-text {
                font-size: 1em; /* Adjusted font size */
                margin-bottom: 25px;
            }
            .categories-grid {
                grid-template-columns: 1fr; /* Stack categories vertically on tablets/mobiles */
                gap: 15px; /* Reduced gap */
            }
            .category-card {
                padding: 20px; /* Adjusted padding */
            }
            .category-icon {
                font-size: 1.8em; /* Smaller icon size */
            }
            .category-title {
                font-size: 1.1em; /* Smaller title font */
            }
            .category-description {
                font-size: 0.85em; /* Smaller description font */
                margin-bottom: 10px;
            }
            .stocks-list {
                gap: 6px; /* Reduced gap for stock chips */
                margin-bottom: 10px;
            }
            .stock-chip {
                font-size: 0.8em; /* Smaller chip font */
                padding: 5px 10px; /* Adjusted padding */
            }
            .trend-info {
                font-size: 0.8em; /* Smaller trend info font */
            }
            .category-card.hot::before {
                font-size: 0.7em; /* Smaller hot badge font */
                padding: 4px 10px;
            }

            .selection-summary {
                padding: 20px; /* Adjusted padding */
            }
            .selected-count {
                font-size: 1.5em; /* Smaller count font */
            }
            .continue-btn {
                padding: 12px 30px; /* Adjusted padding */
                font-size: 1em; /* Smaller button font */
            }
            
            .market-overview {
                grid-template-columns: repeat(2, 1fr); /* Two columns for market overview on tablets */
                gap: 15px;
            }
            .market-card {
                padding: 15px; /* Adjusted padding */
            }
            .market-index {
                font-size: 1em; /* Smaller font */
            }
            .market-value {
                font-size: 1.3em; /* Smaller font */
            }
            .market-change {
                font-size: 0.85em; /* Smaller font */
            }
            
            .selected-sectors {
                padding: 15px; /* Adjusted padding */
            }
            .sector-title {
                font-size: 1.3em; /* Smaller title font */
                margin-bottom: 15px;
            }
            .stocks-grid {
                grid-template-columns: 1fr; /* Stack stock cards vertically on tablets/mobiles */
                gap: 15px;
            }
            .stock-card {
                padding: 15px; /* Adjusted padding */
            }
            .stock-symbol {
                font-size: 1.1em; /* Smaller font */
            }
            .stock-name {
                font-size: 0.8em;
            }
            .stock-price {
                font-size: 1.1em;
            }
            .stock-details {
                grid-template-columns: 1fr; /* Stack stock details vertically */
                gap: 8px;
            }
            .technical-grid {
                grid-template-columns: 1fr; /* Stack technical details vertically */
                gap: 6px;
            }
            .detail-label, .detail-value {
                font-size: 0.8em;
            }
            .technical-analysis {
                padding: 10px;
            }
            .technical-title {
                font-size: 0.9em;
                margin-bottom: 8px;
            }
            .sentiment-title {
                font-size: 1em;
                margin-bottom: 0;
            }
            .chart-container {
                height: 180px; 
            }
            .line-chart-container {
                height: 130px;
            }
            .back-btn {
                padding: 8px 16px;
                font-size: 0.85em;
                margin-bottom: 15px;
            }
            .footer {
                padding: 15px;
                font-size: 0.8em;
            }
            .market-ticker {
                padding: 10px;
                font-size: 0.9em;
            }

            .skeleton-chart-doughnut { width: 100px; height: 100px; }
            .skeleton-chart-line { height: 100px; }
            /* TradingView widget container height adjustment */
            #tv-market-overview-widget-container {
                min-height: 400px; /* Reduce height for tablets */
                height: auto; /* Allow height to adjust */
            }
        }

        @media (max-width: 480px) {
            .header h1, .analysis-header h1 {
                font-size: 1.6em; /* Even smaller font for headers on small phones */
            }
            .header p {
                font-size: 0.9em; /* Even smaller font */
            }
            .intro-text {
                font-size: 0.9em; /* Even smaller font */
            }
            .category-card {
                padding: 15px; /* Further reduced padding */
            }
            .category-icon {
                font-size: 1.6em; /* Even smaller icon */
                margin-left: 10px;
            }
            .category-title {
                font-size: 1em; /* Even smaller title */
            }
            .market-overview {
                grid-template-columns: 1fr; /* Single column for market overview on small phones */
            }
            .stock-header {
                flex-direction: column; /* Stack stock symbol/name and price/change */
                align-items: flex-start;
                gap: 5px; /* Add some space between stacked items */
            }
            .stock-header > div:last-child { /* Targets the div with price and change */
                 align-self: flex-start; /* Align price/change to the start */
            }
            .stock-price {
                margin-bottom: 2px; /* Small space between price and change when stacked */
            }
             .chart-container {
                height: 160px; /* Further adjusted chart height */
            }
            .line-chart-container {
                height: 120px; /* Further adjusted line chart height */
            }
            .continue-btn {
                padding: 10px 25px; /* Further adjusted padding */
                font-size: 0.9em; /* Even smaller button font */
            }
             .selected-sectors {
                padding: 10px; /* Further reduced padding */
            }
             .sector-title {
                font-size: 1.2em; /* Even smaller sector title */
            }
             .skeleton-chart-doughnut { width: 80px; height: 80px; }
             .skeleton-chart-line { height: 80px; }
             /* TradingView widget container height adjustment for small phones */
            #tv-market-overview-widget-container {
                min-height: 300px; /* Reduce height for small phones */
            }
        }
    </style>
</head>
<body>
    <!-- Language buttons moved out of a common container to be positioned independently -->
    <button id="lang-en" class="lang-button" data-lang="en">EN</button>
    <button id="lang-he" class="lang-button active" data-lang="he">HE</button>

    <div id="loginPage" class="login-overlay">
        <div class="login-box">
            <!--  ' 拽专 -->
            <h1 class="login-logo" data-key="appTitle"> SentiVest</h1>
            
            <h1 data-key="welcomeToSentiVest">专  -SentiVest</h1>
            <p class="tagline" data-key="tagline">专 砖 砖 砖拽注转 住住转 住 转转 AI</p>

            <div class="disclaimer">
                <h3 data-key="disclaimerTitle">爪专转 住</h3>
                <p data-key="disclaimerText1">注 驻拽爪   注抓 砖拽注转.<br>砖砖 专转 砖转砖 .<br>抓 注抓 注抓 住 驻 拽转 转 砖拽注.</p>
                <p class="benefits-text" data-key="benefitsText">拽 转转 砖拽 转, 转 住拽专  拽 转专转 注 转 转.</p>
                <p class="confirmation-text" data-key="confirmationText"> 爪 注 \"住\"  砖专 砖拽专转 转.</p>
            </div>
            <input type="text" id="usernameInput" data-placeholder-key="usernamePlaceholder" aria-label=" 转 砖">
            <button id="startButton" class="continue-btn" data-key="loginButton">住</button>
        </div>
    </div>
    <div class="body-container" style="display: none;">
        <div class="container" style="display: none;">
            <!-- 注 专转 转 -->
            <div id="selectionPage" class="page active">
                <div class="header">
                    <h1 data-key="appTitle"> SentiVest</h1>
                    <p data-key="selectionPageHeaderP">专 转 转 砖注 转  拽 爪转 转转 砖转,<br>
                    转 住 拽 砖转 专转 转 砖拽注 砖</p>
                </div>

                <div class="market-ticker">
                    <div class="ticker-content">
                        <!-- 转  住   注 -API -->
                        <span data-key="tickerSP500"> S&P 500: 5,935.94 <span class="positive">(+0.41%)</span></span>
                        <span data-key="tickerNASDAQ"> NASDAQ: 19,242.61 <span class="positive">(+0.67%)</span></span>
                        <span data-key="tickerDOW"> DOW: 42,305.48 <span class="positive">(+0.08%)</span></span>
                        <span data-key="tickerAITop"> 转 AI 转 砖拽</span>
                        <span data-key="tickerGamingGrowth"> 住拽专  爪 砖 25%</span>
                        <span data-key="tickerESGTrend"> ESG 砖拽注转 专 注</span>
                        <span data-key="tickerCryptoVolatile"> 拽专驻:  转转, 拽 专 拽转</span>
                        <span data-key="tickerBiotechBreakthroughs"> 拽: 驻专爪转 专 驻 </span>
                        <span data-key="tickerCloudDemand">锔 注: 拽砖 砖 砖专转 转 砖专转</span>
                        <span data-key="tickerEVPositive"> 专: 爪专转 专 砖  </span>
                    </div>
                </div>

                <div class="main-content">
                    <div class="intro-text" id="welcomeText">
                        <!-- Content will be dynamically set by JS using data-key and greeting function -->
                    </div>

                    <!-- Dark/Light Mode Buttons -->
                    <div class="theme-buttons">
                        <button id="lightModeBtn" class="theme-button" data-key="lightMode">爪 专 锔</button>
                        <button id="darkModeBtn" class="theme-button" data-key="darkMode">爪  </button>
                    </div>

                    <div class="categories-grid" id="categoriesGrid">
                        <!-- Category cards will be dynamically rendered here by JavaScript -->
                    </div>

                    <div class="selection-summary">
                        <div class="selected-count" id="selectedCount">0</div>
                        <div data-key="sectorsSelected">转 专</div>
                        <div style="margin-top: 15px;">
                            <button class="continue-btn" id="continueBtn" disabled data-key="continueToAnalysis">
                                砖 转 砖拽 
                            </button>
                        </div>
                    </div>
                </div>

                <div class="footer">
                    <span data-key="footerSelection1"> 注 专: 22  2025, 15:30 | 转 -NYSE & NASDAQ</span>
                    <br>
                    <span data-key="footerSelection2"> 专 驻转 转   砖 转 驻专</span>
                </div>
            </div>

            <!-- 注 转 -->
            <div id="analysisPage" class="page">
                <div class="analysis-header">
                    <h1 data-key="analysisPageTitle"> SentiVest - 转 砖拽</h1>
                    <p data-key="analysisPageDesc">转 驻专 砖 转 转 砖专转</p>
                </div>

                <div class="market-ticker">
                    <div class="ticker-content">
                        <!-- 转  住   注 -API -->
                        <span data-key="tickerSP500Analysis"> S&P 500 住专 专转 转 转专  驻专专</span>
                        <span data-key="tickerTechGains"> 转  转 转 专 砖注</span>
                        <span data-key="tickerTradeTalks"> 砖拽注 转 砖转 注 砖 转 住专 专"-住</span>
                        <span data-key="tickerNASDAQStreak"> 住"拽 专砖 专 砖注 砖砖 专爪驻转</span>
                        <span data-key="tickerAIandGreen"> 住拽专  转转 专 专拽 爪 转 爪 拽</span>
                        <span data-key="tickerGamingVolume">  住专   转 </span>
                    </div>
                </div>

                <!-- Container for the dynamic TradingView Widget -->
                <div id="tv-market-overview-widget-container" class="tradingview-widget-container" style="margin-top: 40px; min-height: 600px;">
                    <!-- The TradingView widget will be injected here dynamically by JavaScript -->
                </div>

                <div class="main-content">
                    <button id="backBtn" class="back-btn" data-key="backToSelection">
                         专 专转 转
                    </button>

                    <div class="market-overview">
                        <!-- 转  住   注 -API -->
                        <div class="market-card">
                            <div class="market-index">S&P 500</div>
                            <div class="market-value positive">5,935.94</div>
                            <div class="market-change positive">+0.41% (+24.32)</div>
                        </div>
                        <div class="market-card">
                            <div class="market-index">NASDAQ</div>
                            <div class="market-value positive">19,242.61</div>
                            <div class="market-change positive">+0.67% (+127.84)</div>
                        </div>
                        <div class="market-card">
                            <div class="market-index">DOW JONES</div>
                            <div class="market-value positive">42,305.48</div>
                            <div class="market-change positive">+0.08% (+32.24)</div>
                        </div>
                        <div class="market-card">
                            <div class="market-index">VIX (驻)</div>
                            <div class="market-value negative">16.42</div>
                            <div class="market-change negative">-2.1% (-0.35)</div>
                        </div>
                    </div>
                    
                    <div id="selectedSectorsContainer">
                        <!--  爪 转 砖专 注 专住转 砖 -->
                        <!-- Skeleton loaders will be injected here by JS -->
                    </div>
                </div>

                <div class="footer">
                    <span data-key="footerAnalysis1"> 转 注  转 -NYSE & NASDAQ</span>
                    <span data-key="footerAnalysis2"> 转 住住 注 AI 专转 转拽</span>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/
// Chart is globally available from the CDN scripts in <head>
// TradingView will be dynamically loaded and initialized

const translations = {
    he: {
        appTitle: " SentiVest",
        welcomeToSentiVest: "专  -SentiVest",
        tagline: "专 砖 砖 砖拽注转 住住转 住 转转 AI",
        disclaimerTitle: "爪专转 住",
        disclaimerText1: "注 驻拽爪   注抓 砖拽注转.<br>砖砖 专转 砖转砖 .<br>抓 注抓 注抓 住 驻 拽转 转 砖拽注.",
        benefitsText: "拽 转转 砖拽 转, 转 住拽专  拽 转专转 注 转 转.",
        confirmationText: " 爪 注 \"住\"  砖专 砖拽专转 转.",
        usernamePlaceholder: " 转 砖  转",
        loginButton: "住",
        greetingMorning: "拽专 ",
        greetingAfternoon: "爪专 ",
        greetingEvening: "注专 ",
        today: "",
        selectCategoriesIntro1: "专 转   转:",
        selectCategoriesIntro2: "转  转专 砖拽 专注 住 -",
        lightMode: "爪 专 锔",
        darkMode: "爪  ",
        gamingTitle: " 专 ",
        gamingDesc: "转注砖转  爪 专驻转, e-sports, 专住, VR/AR",
        gamingTrend: "  -25% 砖 | 住转 砖 180 专 专",
        aiTitle: " 转转 (AI)",
        aiDesc: "专   专注 - ChatGPT, Copilot, Claude, machine learning",
        aiTrend: "砖拽 AI 注 -1.8 专 专 注 2030",
        cloudTitle: "注 -SaaS",
        cloudDesc: "转 注 转, 爪, 转转 砖专转",
        cloudTrend: "70% 注住拽 注专 注 | 爪 砖 15% 砖",
        biotechTitle: "",
        biotechDesc: "驻 驻, gene therapy, 住, 专驻 转转 砖转",
        biotechTrend: "驻转  | 驻 Gene editing 注 2025",
        cyberTitle: "住专 ",
        cyberDesc: "拽  = 爪专  专 转 注 住专",
        cyberTrend: "砖拽 住专 注 -500 专 专 注 2030",
        cryptoTitle: "拽爪 拽专驻",
        cryptoDesc: "注转 , NFT, Web3,  .",
        cryptoTrend: "砖拽 拽专驻 专 注转 | 抓 住 专",
        esgTitle: "ESG 专转 专转转",
        esgDesc: "砖拽注转 转-拽, 专 拽 - 专 注",
        esgTrend: "30 专 专 砖拽注转 ESG 注转",
        techTitle: "",
        techDesc: "转 拽, 转, 专, 砖",
        techTrend: "  转 砖拽 专",
        automotiveTitle: "专",
        automotiveDesc: "专 砖, 专 , 爪专 专 住专转",
        automotiveTrend: "注专 专 砖 抓 专 注",
        greenTitle: "专 专拽",
        greenDesc: "专 转砖转, 住专, 专, 专 专拽",
        greenTrend: "注专 注 专 转砖转",
        batteriesTitle: "住转 住 专",
        batteriesDesc: "驻转 专 转砖转, 专 砖 转 注转",
        batteriesTrend: "砖拽 住转 注 -400 专 专 注 2030",
        foodTitle: " 砖拽转",
        foodDesc: " 驻, 爪, sustainable food, 转 拽专",
        foodTrend: " 爪 爪 -45% 砖",
        smarthomeTitle: "转  -IoT",
        smarthomeDesc: "转  砖 注转, Internet of Things, 爪",
        smarthomeTrend: "50 专 砖专 专 注 2030",
        spaceTitle: " 转注驻",
        spaceDesc: "转专转 , , SpaceX,  砖 砖 ",
        spaceTrend: "转  转注 -1 专 专 注 2040",
        mediaTitle: "转拽砖专转 ",
        mediaDesc: "住专, 专砖转转 专转转, 专转 拽.",
        mediaTrend: "转 住专 砖",
        medtechTitle: "转 专驻转",
        medtechDesc: "砖专 专驻, 住拽, 专转 转.",
        medtechTrend: "砖转 专拽 专专转 住",
        reitsTitle: `" (REITs)`,
        reitsDesc: `拽专转 专 砖拽注转 住  - 专, 砖专, 住专.`,
        reitsTrend: `转 住拽专 住驻爪驻 专转 专转 `,
        financeTitle: "驻住 驻拽",
        financeDesc: "拽, 专转 , 专住转,  驻住转.",
        financeTrend: "驻转 驻拽 砖 转 驻 拽转",
        sectorsSelected: "转 专",
        continueToAnalysis: "砖 转 砖拽 ",
        footerSelection1: " 注 专: 22  2025, 15:30 | 转 -NYSE & NASDAQ",
        footerSelection2: " 专 驻转 转   砖 转 驻专",
        analysisPageTitle: " SentiVest - 转 砖拽",
        analysisPageDesc: "转 驻专 砖 转 转 砖专转",
        backToSelection: " 专 专转 转",
        footerAnalysis1: " 转 注  转 -NYSE & NASDAQ",
        footerAnalysis2: " 转 住住 注 AI 专转 转拽",
        loadingCategory: "注 转...",
        errorLoadingData: "砖 注转 转.  住 砖转 专 转专.",
        stockDataError: "砖: 转   转拽.",
        unknownStock: "  注",
        volume: "驻 住专:",
        marketCap: "砖 砖拽:",
        pe: "P/E:",
        rsi: "RSI:",
        technicalAnalysis: "转 ",
        sma50: "SMA 50:",
        sma200: "SMA 200:",
        support: "转:",
        resistance: "转转:",
        newsAnalysis: "转 转转 专转",
        positiveArticles: "转转 转:",
        negativeArticles: "转转 砖转:",
        neutralArticles: "转转 专转:",
        overallSentiment: "住 :",
        positiveSentiment: "",
        negativeSentiment: "砖",
        neutralSentiment: "专",
        overallSentimentAnalysis: "转 住 ",
        sentimentInfoTitle: "住专 注 住 住",
        sentimentInfoPositive: "<strong>:</strong> 砖转 爪注转 注 驻爪 爪, 转 专 , 砖拽转 爪专 爪转  砖专 注  住.",
        sentimentInfoNegative: "<strong>砖:</strong> 砖转 爪注转 注 住, 转爪转 转, 注转 专专转, 转专转 专转  专转 专.",
        sentimentInfoNeutral: "<strong>专:</strong> 砖转 注转转  砖驻注 专专 注 专 ,  注转 转 注 专   注 砖拽.",
        stockPerformance30Days: "爪注  (30 )",
        aiInsight: "转转 AI:",
        loadingInsight: "注 转...",
        errorLoadingInsight: "砖 注转 转.",
        noCategoriesSelected: " 专 转  砖转  转拽.",
        priceOnDay: "专 ",
        price: "专",
        tickerSP500: " S&P 500: 5,935.94 (+0.41%)",
        tickerNASDAQ: " NASDAQ: 19,242.61 (+0.67%)",
        tickerDOW: " DOW: 42,305.48 (+0.08%)",
        tickerAITop: " 转 AI 转 砖拽",
        tickerGamingGrowth: " 住拽专  爪 砖 25%",
        tickerESGTrend: " ESG 砖拽注转 专 注",
        tickerCryptoVolatile: " 拽专驻:  转转, 拽 专 拽转",
        tickerBiotechBreakthroughs: " 拽: 驻专爪转 专 驻 ",
        tickerCloudDemand: "锔 注: 拽砖 砖 砖专转 转 砖专转",
        tickerEVPositive: " 专: 爪专转 专 砖  ",
        tickerSP500Analysis: " S&P 500 住专 专转 转 转专  驻专专",
        tickerTechGains: " 转  转 转 专 砖注",
        tickerTradeTalks: " 砖拽注 转 砖转 注 砖 转 住专 专\"-住",
        tickerNASDAQStreak: " 住\"拽 专砖 专 砖注 砖砖 专爪驻转",
        tickerAIandGreen: " 住拽专  转转 专 专拽 爪 转 爪 拽",
        tickerGamingVolume: "  住专   转 ",
        followMarketsTradingView: "注拽 专  砖拽 -TradingView"
    },
    en: { // Add English translations here
        appTitle: " SentiVest",
        welcomeToSentiVest: "Welcome to SentiVest",
        tagline: "Your personal guide to sentiment-driven investments and AI insights",
        disclaimerTitle: "Risk Disclaimer",
        disclaimerText1: "The information in this application does not constitute investment advice.<br>Use is at the user's sole risk.<br>It is recommended to consult a qualified advisor before making investment decisions.",
        benefitsText: "Get smart market insights, analyze leading sectors, and receive alerts on hot trends.",
        confirmationText: " By clicking 'Enter' I confirm that I have read and understood.",
        usernamePlaceholder: "Enter your name to start",
        loginButton: "Enter",
        greetingMorning: "Good morning",
        greetingAfternoon: "Good afternoon",
        greetingEvening: "Good evening",
        today: "Today",
        selectCategoriesIntro1: "Select from the following categories to get started:",
        selectCategoriesIntro2: "The hottest sectors in the market are currently marked with ",
        lightMode: "Light Mode 锔",
        darkMode: "Dark Mode ",
        gamingTitle: "Gaming & Digital Entertainment",
        gamingDesc: "The gaming industry is experiencing massive growth: e-sports, metaverse, VR/AR.",
        gamingTrend: "Gaming grew by 25% this year | $180 billion in revenue.",
        aiTitle: "Artificial Intelligence (AI)",
        aiDesc: "The hottest sector right now: ChatGPT, Copilot, Claude, machine learning.",
        aiTrend: "AI market to reach $1.8 trillion by 2030.",
        cloudTitle: "Cloud & SaaS",
        cloudDesc: "Work-from-home trend, digitalization, software as a service.",
        cloudTrend: "70% of businesses moved to the cloud | 15% annual growth.",
        biotechTitle: "Biotechnology",
        biotechDesc: "Revolutionary treatments, gene therapy, vaccines, personalized medicine.",
        biotechTrend: "Genomic revolution | Gene editing treatments by 2025.",
        cyberTitle: "Cyber & Security",
        cyberDesc: "Increased hacking = growing need for information security and cyber defense.",
        cyberTrend: "Cyber market to reach $500 billion by 2030.",
        cryptoTitle: "Blockchain & Crypto",
        cryptoDesc: "Digital currencies, NFTs, Web3, smart contracts.",
        cryptoTrend: "Crypto market resuming uptrend | Increasing institutional adoption.",
        esgTitle: "ESG & Social Responsibility",
        esgDesc: "Sustainable investments, clean energy - a global trend.",
        esgTrend: "$30 trillion in global ESG investments.",
        techTitle: "Technology",
        techDesc: "Tech stocks, software, hardware, computing.",
        techTrend: "Technology leading the market rebound.",
        automotiveTitle: "Automotive",
        automotiveDesc: "Electric vehicles, autonomous cars, traditional car manufacturers.",
        automotiveTrend: "Global shift to electric vehicles accelerating.",
        greenTitle: "Green Energy",
        greenDesc: "Renewable energy, solar, wind, green hydrogen.",
        greenTrend: "Global transition to renewable energy.",
        batteriesTitle: "Batteries & Energy Storage",
        batteriesDesc: "Key to renewable energy, electric vehicles, and future technologies.",
        batteriesTrend: "Battery market to reach $400 billion by 2030.",
        foodTitle: "Food & Beverage",
        foodDesc: "Alternative food, vegetarian, sustainable food, luxury brands.",
        foodTrend: "Plant-based food growing by 45% this year.",
        smarthomeTitle: "Smart Home & IoT",
        smarthomeDesc: "The smart home of the future, Internet of Things, automation.",
        smarthomeTrend: "50 billion connected devices by 2030.",
        spaceTitle: "Space & Aviation",
        spaceDesc: "Space tourism, satellites, SpaceX, the new space economy.",
        spaceTrend: "Space economy to reach $1 trillion by 2040.",
        mediaTitle: "Media & Communication",
        mediaDesc: "Streaming, social networks, telecom companies.",
        mediaTrend: "Streaming wars at their peak.",
        medtechTitle: "Medical Technologies",
        medtechDesc: "Medical devices, diagnostics, digital health.",
        medtechTrend: "Innovation in surgical robotics and telemedicine.",
        reitsTitle: "Real Estate (REITs)",
        reitsDesc: "REITs investing in income-generating properties - residential, office, commercial.",
        reitsTrend: "Opportunities in specific sectors despite high interest rates.",
        financeTitle: "Finance & Fintech",
        financeDesc: "Banks, insurance companies, stock exchanges, financial technology.",
        financeTrend: "Fintech revolution changing the face of banking.",
        sectorsSelected: "Sectors Selected",
        continueToAnalysis: "Continue to Market Analysis ",
        footerSelection1: " Last Updated: June 22, 2025, 15:30 | Data from NYSE & NASDAQ",
        footerSelection2: " Select at least one sector to proceed to detailed analysis",
        analysisPageTitle: " SentiVest - Market Analysis",
        analysisPageDesc: "Detailed analysis of stocks in your selected sectors",
        backToSelection: " Back to Sector Selection",
        footerAnalysis1: " Real-time data from NYSE & NASDAQ",
        footerAnalysis2: " Analysis based on AI and advanced algorithms",
        loadingCategory: "Loading category...",
        errorLoadingData: "Error loading data. Please try again later.",
        stockDataError: "Error: Invalid stock data.",
        unknownStock: "Unknown Stock",
        volume: "Volume:",
        marketCap: "Market Cap:",
        pe: "P/E:",
        rsi: "RSI:",
        technicalAnalysis: "Technical Analysis",
        sma50: "SMA 50:",
        sma200: "SMA 200:",
        support: "Support:",
        resistance: "Resistance:",
        newsAnalysis: "Latest News Analysis",
        positiveArticles: "Positive Articles:",
        negativeArticles: "Negative Articles:",
        neutralArticles: "Neutral Articles:",
        overallSentiment: "Overall Sentiment:",
        positiveSentiment: "Positive",
        negativeSentiment: "Negative",
        neutralSentiment: "Neutral",
        overallSentimentAnalysis: "Overall Sentiment Analysis",
        sentimentInfoTitle: "Explanation of Sentiment Types",
        sentimentInfoPositive: "<strong>Positive:</strong> News indicating growth potential, positive earnings reports, successful product launches, or analyst upgrades.",
        sentimentInfoNegative: "<strong>Negative:</strong> News indicating risks, disappointing results, regulatory issues, increasing competition, or downgrades.",
        sentimentInfoNeutral: "<strong>Neutral:</strong> Factual news with no clear impact on stock price, such as general company announcements or market reports.",
        stockPerformance30Days: "Stock Performance (30 Days)",
        aiInsight: "AI Insight:",
        loadingInsight: "Loading insight...",
        errorLoadingInsight: "Error loading insight.",
        noCategoriesSelected: "No categories selected or data is invalid.",
        priceOnDay: "Price on day",
        price: "Price",
        tickerSP500: " S&P 500: 5,935.94 (+0.41%)",
        tickerNASDAQ: " NASDAQ: 19,242.61 (+0.67%)",
        tickerDOW: " DOW: 42,305.48 (+0.08%)",
        tickerAITop: " Top AI Stocks Leading the Market",
        tickerGamingGrowth: " Gaming Sector Growing by 25%",
        tickerESGTrend: " ESG Investments Global Trend",
        tickerCryptoVolatile: " Crypto: Volatile Day, Bitcoin Slightly Down",
        tickerBiotechBreakthroughs: " Biotech: Genetic Treatment Breakthroughs",
        tickerCloudDemand: "锔 Cloud: Peak Demand for SaaS Services",
        tickerEVPositive: " Automotive: EV Manufacturers in Positive Momentum",
        tickerSP500Analysis: " S&P 500 Trading at Highest Levels Since February",
        tickerTechGains: " Technology Stocks Leading Weekly Gains",
        tickerTradeTalks: " Investors Awaiting US-China Trade Talk News",
        tickerNASDAQStreak: " NASDAQ Posts Gains for Third Consecutive Week",
        tickerAIandGreen: " AI and Green Energy Sectors Show Strong Growth Data",
        tickerGamingVolume: " High Trading Volume in Gaming Stocks",
        followMarketsTradingView: "Follow all markets on TradingView"
    }
};

let currentLanguage = 'he'; // Default language

// Apply saved theme on load
const savedTheme = localStorage.getItem('theme') || 'light'; // Default to light

// --- Proxy Server URL ---
// IMPORTANTconst: Replaced with the actual URL where your Flask proxy server is running on Azure.
 const PROXY_BASE_URL = 'https://sentivest-app-cuh8b5cpab0iwgtgi.azurewebsites.net/finnhub-proxy';; // Base URL for your proxy endpoints
// --- End Proxy Server URL ---

// Function to generate fake historical data for charts when real data is unavailable
const generateFakeHistory = (start, points = 30, volatility = 1) => {
    const data = [];
    let current = start;
    for (let i = 0; i < points; i++) {
        data.push(current);
        current += (Math.random() - 0.48) * volatility; // slight upward bias
    }
    return data;
};

function setLanguage(lang) {
    // Defensive check: Ensure the requested language exists in translations
    if (!translations[lang]) {
        console.error(`Attempted to set invalid language: ${lang}. Defaulting to 'he'.`);
        lang = 'he'; // Fallback to a known good language
    }

    currentLanguage = lang;
    const html = document.documentElement;
    html.setAttribute('lang', lang);
    html.setAttribute('dir', lang === 'he' ? 'rtl' : 'ltr');

    // Update language switcher buttons
    document.querySelectorAll('.lang-button').forEach(button => {
        if (button.dataset.lang === lang) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });

    // Update all translatable elements
    document.querySelectorAll('[data-key]').forEach(element => {
        const key = element.dataset.key;
        // Add a check for translations[lang] and translations[lang][key]
        if (translations[lang] && translations[lang][key] !== undefined) {
            // Handle special cases for dynamic content like greetings
            if (key.startsWith('greeting')) {
                const username = document.getElementById('usernameInput').value.trim();
                const now = new Date();
                const hours = now.getHours();
                let greetingKey = '';
                if (hours >= 5 && hours < 12) {
                    greetingKey = 'greetingMorning';
                } else if (hours >= 12 && hours < 18) {
                    greetingKey = 'greetingAfternoon';
                } else {
                    greetingKey = 'greetingEvening';
                }
                const dateString = now.toLocaleDateString(currentLanguage === 'he' ? 'he-IL' : 'en-US');
                element.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 1.3em; font-weight: bold;">${translations[currentLanguage][greetingKey]}, ${username}</div>
                        <div style="font-size: 1em; color: var(--text-color-secondary);">${translations[currentLanguage].today} ${dateString}</div>
                    </div>
                    <strong><span data-key="selectCategoriesIntro1">${translations[currentLanguage].selectCategoriesIntro1}</span></strong><br>
                    <span data-key="selectCategoriesIntro2">${translations[currentLanguage].selectCategoriesIntro2}</span>
                `;
            } else if (typeof translations[lang][key] === 'string') {
                element.innerHTML = translations[lang][key]; // Use innerHTML for text that might contain <br> or <strong>
            }
        }
    });

    // Update placeholders
    document.querySelectorAll('[data-placeholder-key]').forEach(element => {
        const key = element.dataset.placeholderKey;
        if (translations[lang] && translations[lang][key] !== undefined) {
            element.placeholder = translations[lang][key];
        }
    });

    // Update specific text contents that are not easily data-keyed (e.g., dynamic elements or Chart.js)
    updateDynamicText();
    if (typeof Chart !== 'undefined' && window.myCharts) { // Assuming window.myCharts holds chart instances
        Object.values(window.myCharts).forEach((chart) => {
            if (chart) {
                chart.options.plugins.tooltip.callbacks.title = (items) => `${translations[currentLanguage].priceOnDay} ${items[0].label}`;
                chart.options.plugins.tooltip.callbacks.label = (c) => `${translations[currentLanguage].price}: $${Number(c.parsed.y).toFixed(2)}`;
                // For doughnut chart, update labels
                if (chart.config.type === 'doughnut') {
                    chart.data.labels = [translations[currentLanguage].positiveSentiment, translations[currentLanguage].negativeSentiment, translations[currentLanguage].neutralSentiment];
                }
                chart.update();
            }
        });
    }

    // NEW: If analysis page is active, re-render its content for translation
    const analysisPage = document.getElementById('analysisPage');
    const selectionPage = document.getElementById('selectionPage');
    if (analysisPage && analysisPage.classList.contains('active')) {
        // Re-render TradingView widget with new locale
        renderTradingViewWidget(selectedCategories);
        // Re-generate stock cards with new language
        // We need to pass the *current* state of selectedCategories to goToAnalysis
        // to ensure it re-renders the correct data.
        goToAnalysis(true); // Pass a flag to indicate it's a language change re-render
    }
    // Also ensure category cards are re-rendered for language changes
    if (selectionPage && selectionPage.classList.contains('active')) {
        renderCategoryCards();
    }
}

function updateDynamicText() {
    // Update login greeting
    const usernameInput = document.getElementById('usernameInput');
    const username = usernameInput.value.trim();
    const now = new Date();
    const hours = now.getHours();
    let greetingKey = '';

    if (hours >= 5 && hours < 12) {
        greetingKey = 'greetingMorning';
    } else if (hours >= 12 && hours < 18) {
        greetingKey = 'greetingAfternoon';
    } else {
        greetingKey = 'greetingEvening';
    }

    const dateString = now.toLocaleDateString(currentLanguage === 'he' ? 'he-IL' : 'en-US');

    // Update the welcomeText div
    const welcomeTextDiv = document.getElementById('welcomeText');
    if (welcomeTextDiv && translations[currentLanguage]) { // Add check for translations[currentLanguage]
        welcomeTextDiv.innerHTML = `
            <div style="margin-bottom: 15px;">
                <div style="font-size: 1.3em; font-weight: bold;">${translations[currentLanguage][greetingKey]}, ${username}</div>
                <div style="font-size: 1em; color: var(--text-color-secondary);">${translations[currentLanguage].today} ${dateString}</div>
            </div>
            <strong><span data-key="selectCategoriesIntro1">${translations[currentLanguage].selectCategoriesIntro1}</span></strong><br>
            <span data-key="selectCategoriesIntro2">${translations[currentLanguage].selectCategoriesIntro2}</span>
        `;
    }

    // Update the disclaimer confirmation text, as it's part of innerHTML
    const confirmationTextElement = document.querySelector('.disclaimer .confirmation-text');
    if (confirmationTextElement && translations[currentLanguage]) { // Add check
        confirmationTextElement.innerHTML = ` ${translations[currentLanguage].confirmationText}`;
    }

    // Update AI Insight loading/error messages
    document.querySelectorAll('.stock-card .ai-insight').forEach(aiInsightDiv => {
        if (!translations[currentLanguage]) return; // Add check

        const strongTag = aiInsightDiv.querySelector('strong');
        if (strongTag) {
            strongTag.innerHTML = `<i class="fas fa-robot"></i> ${translations[currentLanguage].aiInsight}`;
        }
        const loadingSpan = aiInsightDiv.querySelector('.loading-dots');
        if (loadingSpan) {
            loadingSpan.innerHTML = `<span>.</span><span>.</span><span>.</span> ${translations[currentLanguage].loadingInsight}`;
        }
        // This part is handled by the fetchAIInsight promise resolution
        // but for initial display or error, it needs to be set.
        // The logic below is a fallback/initial state.
        if (aiInsightDiv.textContent.includes('砖 注转 转') || aiInsightDiv.textContent.includes('Error loading insight')) {
            aiInsightDiv.innerHTML = `<strong><i class="fas fa-robot"></i> ${translations[currentLanguage].aiInsight}</strong> ${translations[currentLanguage].errorLoadingInsight}`;
        }
    });

    // Update the info tooltip content dynamically
    const infoTooltip = document.querySelector('.info-tooltip');
    if (infoTooltip && translations[currentLanguage]) { // Add check
        infoTooltip.innerHTML = `
            <p>${translations[currentLanguage].sentimentInfoPositive}</p>
            <p>${translations[currentLanguage].sentimentInfoNegative}</p>
            <p>${translations[currentLanguage].sentimentInfoNeutral}</p>
        `;
    }
}


// Defines the categories data, including stock symbols.
// The order of these categories in this object determines their display order.
const categoriesData = {
    gaming: {
        name_he: " 专 ", name_en: "Gaming & Digital Entertainment",
        icon: "<i class='fas fa-gamepad'></i>",
        isHot: true, // Mark as hot
        stocks: [
            { symbol: "NVDA", tvSymbol: "NASDAQ:NVDA", finnhubSymbol: "NVDA", name: "NVIDIA Corporation" },
            { symbol: "AMD", tvSymbol: "NASDAQ:AMD", finnhubSymbol: "AMD", name: "Advanced Micro Devices" },
            { symbol: "RBLX", tvSymbol: "NYSE:RBLX", finnhubSymbol: "RBLX", name: "Roblox Corporation" },
            { symbol: "EA", tvSymbol: "NASDAQ:EA", finnhubSymbol: "EA", name: "Electronic Arts" },
            { symbol: "TTWO", tvSymbol: "NASDAQ:TTWO", finnhubSymbol: "TTWO", name: "Take-Two Interactive" },
        ]
    },
    ai: {
        name_he: " 转转 (AI)", name_en: "Artificial Intelligence (AI)",
        icon: "<i class='fas fa-brain'></i>",
        isHot: true, // Mark as hot
        stocks: [
            { symbol: "NVDA", tvSymbol: "NASDAQ:NVDA", finnhubSymbol: "NVDA", name: "NVIDIA Corporation" },
            { symbol: "GOOGL", tvSymbol: "NASDAQ:GOOGL", finnhubSymbol: "GOOGL", name: "Alphabet Inc." },
            { symbol: "MSFT", tvSymbol: "NASDAQ:MSFT", finnhubSymbol: "MSFT", name: "Microsoft Corporation" },
            { symbol: "PLTR", tvSymbol: "NYSE:PLTR", finnhubSymbol: "PLTR", name: "Palantir Technologies" },
        ]
    },
    cloud: {
        name_he: "注 -SaaS", name_en: "Cloud & SaaS",
        icon: "<i class='fas fa-cloud'></i>",
        isHot: true, // Mark as hot
        stocks: [
            { symbol: "CRM", tvSymbol: "NYSE:CRM", finnhubSymbol: "CRM", name: "Salesforce Inc." },
            { symbol: "SNOW", tvSymbol: "NYSE:SNOW", finnhubSymbol: "SNOW", name: "Snowflake Inc." },
            { symbol: "OKTA", tvSymbol: "NASDAQ:OKTA", finnhubSymbol: "OKTA", name: "Okta, Inc." },
        ]
    },
    biotech: {
        name_he: "", name_en: "Biotechnology",
        icon: "<i class='fas fa-dna'></i>",
        isHot: true, // Mark as hot
        stocks: [
            { symbol: "MRNA", tvSymbol: "NASDAQ:MRNA", finnhubSymbol: "MRNA", name: "Moderna Inc." },
            { symbol: "GILD", tvSymbol: "NASDAQ:GILD", finnhubSymbol: "Gilead Sciences", name: "Gilead Sciences" },
            { symbol: "VRTX", tvSymbol: "NASDAQ:VRTX", finnhubSymbol: "VRTX", name: "Vertex Pharmaceuticals" },
        ]
    },
    cyber: {
        name_he: "住专 ", name_en: "Cyber & Security",
        icon: "<i class='fas fa-shield-alt'></i>",
        isHot: true, // Mark as hot
        stocks: [
            { symbol: "CRWD", tvSymbol: "NASDAQ:CRWD", finnhubSymbol: "CRWD", name: "CrowdStrike Holdings" },
            { symbol: "PANW", tvSymbol: "NASDAQ:PANW", finnhubSymbol: "PANW", name: "Palo Alto Networks" },
            { symbol: "FTNT", tvSymbol: "NASDAQ:FTNT", finnhubSymbol: "FTNT", name: "Fortinet, Inc." },
        ]
    },
    crypto: {
        name_he: "拽爪 拽专驻", name_en: "Blockchain & Crypto",
        icon: "<i class='fab fa-bitcoin'></i>",
        isHot: true, // Mark as hot
        // IMPORTANT: Finnhub API for crypto is different (e.g., BINANCE:BTCUSDT),
        // and for simplicity and to avoid breaking existing structure with different API calls,
        // these crypto stocks will remain mocked for the purpose of this example.
        // The news sentiment will still link to Google News search.
        stocks: [
            { symbol: "BTCUSD", tvSymbol: "COINBASE:BTCUSD", name: "Bitcoin", isCrypto: true, price: 65025.00, change: "-2.50%", volume: "25.8B", marketCap: "1.28T", pe: "-", sentiment: { positive: 70, negative: 20, neutral: 10 }, rsi: 65.0, sma50: 67000, sma200: 60000, support: 64000, resistance: 68000, historicalData: generateFakeHistory(68000, 30, 1000) },
            { symbol: "ETHUSD", tvSymbol: "COINBASE:ETHUSD", name: "Ethereum", isCrypto: true, price: 3515.00, change: "-3.10%", volume: "15.2B", marketCap: "422B", pe: "-", sentiment: { positive: 75, negative: 15, neutral: 10 }, rsi: 68.0, sma50: 3600, sma200: 3200, support: 3450, resistance: 3650, historicalData: generateFakeHistory(3600, 30, 150) },
            { symbol: "SOLUSD", tvSymbol: "COINBASE:SOLUSD", name: "Solana", isCrypto: true, price: 134.50, change: "-4.20%", volume: "2.1B", marketCap: "62B", pe: "-", sentiment: { positive: 68, negative: 22, neutral: 10 }, rsi: 71.0, sma50: 145, sma200: 130, support: 130, resistance: 140, historicalData: generateFakeHistory(150, 30, 10) },
            { symbol: "XRPUSD", tvSymbol: "COINBASE:XRPUSD", name: "Ripple", isCrypto: true, price: 0.48, change: "-1.80%", volume: "1.1B", marketCap: "26.7B", pe: "-", sentiment: { positive: 50, negative: 35, neutral: 15 }, rsi: 52.0, sma50: 0.50, sma200: 0.52, support: 0.47, resistance: 0.50, historicalData: generateFakeHistory(0.51, 30, 0.02) },
            { symbol: "ADAUSD", tvSymbol: "COINBASE:ADAUSD", name: "Cardano", isCrypto: true, price: 0.38, change: "-2.10%", volume: "350M", marketCap: "13.6B", pe: "-", sentiment: { positive: 60, negative: 25, neutral: 15 }, rsi: 58.0, sma50: 0.42, sma200: 0.45, support: 0.37, resistance: 0.40, historicalData: generateFakeHistory(0.43, 30, 0.03) },
        ]
    },
    esg: {
        name_he: "ESG 专转 专转转", name_en: "ESG & Social Responsibility",
        icon: "<i class='fas fa-handshake-angle'></i>",
        isHot: false,
        stocks: [
            { symbol: "TSLA", tvSymbol: "NASDAQ:TSLA", finnhubSymbol: "TSLA", name: "Tesla Inc." },
            { symbol: "NEE", tvSymbol: "NYSE:NEE", finnhubSymbol: "NEE", name: "NextEra Energy" },
            { symbol: "ICLN", tvSymbol: "NASDAQ:ICLN", finnhubSymbol: "ICLN", name: "iShares Global Clean Energy ETF" }
        ]
    },
    tech: {
        name_he: "", name_en: "Technology",
        icon: "<i class='fas fa-laptop-code'></i>",
        isHot: false,
        stocks: [
            { symbol: "AAPL", tvSymbol: "NASDAQ:AAPL", finnhubSymbol: "AAPL", name: "Apple Inc." },
            { symbol: "GOOGL", tvSymbol: "NASDAQ:GOOGL", finnhubSymbol: "GOOGL", name: "Alphabet Inc." },
            { symbol: "MSFT", tvSymbol: "NASDAQ:MSFT", finnhubSymbol: "MSFT", name: "Microsoft Corporation" },
            { symbol: "META", tvSymbol: "NASDAQ:META", finnhubSymbol: "META", name: "Meta Platforms" }
        ]
    },
    automotive: {
        name_he: "专", name_en: "Automotive",
        icon: "<i class='fas fa-car-side'></i>",
        isHot: false,
        stocks: [
            { symbol: "TSLA", tvSymbol: "NASDAQ:TSLA", finnhubSymbol: "TSLA", name: "Tesla Inc." },
            { symbol: "F", tvSymbol: "NYSE:F", finnhubSymbol: "F", name: "Ford Motor Company" },
            { symbol: "GM", tvSymbol: "NYSE:GM", finnhubSymbol: "GM", name: "General Motors" }
        ]
    },
    green: {
        name_he: "专 专拽", name_en: "Green Energy",
        icon: "<i class='fas fa-leaf'></i>",
        isHot: false,
        stocks: [
            { symbol: "ENPH", tvSymbol: "NASDAQ:ENPH", finnhubSymbol: "ENPH", name: "Enphase Energy" },
            { symbol: "SEDG", tvSymbol: "NASDAQ:SEDG", finnhubSymbol: "SEDG", name: "SolarEdge Technologies" },
            { symbol: "NEE", tvSymbol: "NYSE:NEE", finnhubSymbol: "NEE", name: "NextEra Energy" }
        ]
    },
    batteries: {
        name_he: "住转 住 专", name_en: "Batteries & Energy Storage",
        icon: "<i class='fas fa-battery-full'></i>",
        isHot: true, // Mark as hot
        stocks: [
            { symbol: "QS", tvSymbol: "NYSE:QS", finnhubSymbol: "QS", name: "QuantumScape Corp" },
            { symbol: "BE", tvSymbol: "NYSE:BE", finnhubSymbol: "BE", name: "Bloom Energy Corp" },
            { symbol: "TSLA", tvSymbol: "NASDAQ:TSLA", finnhubSymbol: "TSLA", name: "Tesla Inc." }
        ]
    },
    food: {
        name_he: " 砖拽转", name_en: "Food & Beverage",
        icon: "<i class='fas fa-burger'></i>",
        isHot: false,
        stocks: [
            { symbol: "KO", tvSymbol: "NYSE:KO", finnhubSymbol: "KO", name: "Coca-Cola Co" },
            { symbol: "PEP", tvSymbol: "NASDAQ:PEP", finnhubSymbol: "PEP", name: "PepsiCo Inc." },
            { symbol: "BYND", tvSymbol: "NASDAQ:BYND", finnhubSymbol: "BYND", name: "Beyond Meat Inc." }
        ]
    },
    smarthome: {
        name_he: "转  -IoT", name_en: "Smart Home & IoT",
        icon: "<i class='fas fa-house-chimney'></i>",
        isHot: false,
        stocks: [
            { symbol: "AMZN", tvSymbol: "NASDAQ:AMZN", finnhubSymbol: "AMZN", name: "Amazon.com Inc." },
            { symbol: "GOOGL", tvSymbol: "NASDAQ:GOOGL", finnhubSymbol: "GOOGL", name: "Alphabet Inc." },
            { symbol: "AAPL", tvSymbol: "NASDAQ:AAPL", finnhubSymbol: "AAPL", name: "Apple Inc." }
        ]
    },
    space: {
        name_he: " 转注驻", name_en: "Space & Aviation",
        icon: "<i class='fas fa-rocket'></i>",
        isHot: true, // Mark as hot
        stocks: [
            { symbol: "BA", tvSymbol: "NYSE:BA", finnhubSymbol: "BA", name: "Boeing Co" },
            { symbol: "LMT", tvSymbol: "NYSE:LMT", finnhubSymbol: "LMT", name: "Lockheed Martin Corp" },
            { symbol: "SPCE", tvSymbol: "NYSE:SPCE", finnhubSymbol: "SPCE", name: "Virgin Galactic Holdings" }
        ]
    },
    media: {
        name_he: "转拽砖专转 ", name_en: "Media & Communication",
        icon: "<i class='fas fa-tv'></i>",
        isHot: false,
        stocks: [
            { symbol: "NFLX", tvSymbol: "NASDAQ:NFLX", finnhubSymbol: "NFLX", name: "Netflix, Inc." },
            { symbol: "DIS", tvSymbol: "NYSE:DIS", finnhubSymbol: "DIS", name: "The Walt Disney Company" },
            { symbol: "CMCSA", tvSymbol: "NASDAQ:CMCSA", finnhubSymbol: "CMCSA", name: "Comcast Corporation" },
        ]
    },
    medtech: {
        name_he: "转 专驻转", name_en: "Medical Technologies",
        icon: "<i class='fas fa-stethoscope'></i>",
        isHot: false,
        stocks: [
            { symbol: "ISRG", tvSymbol: "NASDAQ:ISRG", finnhubSymbol: "ISRG", name: "Intuitive Surgical, Inc." },
            { symbol: "MDT", tvSymbol: "NYSE:MDT", finnhubSymbol: "MDT", name: "Medtronic plc" },
            { symbol: "ABT", tvSymbol: "NYSE:ABT", finnhubSymbol: "ABT", name: "Abbott Laboratories" },
        ]
    },
    reits: {
        name_he: `" (REITs)`, name_en: "Real Estate (REITs)",
        icon: "<i class='fas fa-building'></i>",
        isHot: false,
        stocks: [
            { symbol: "O", tvSymbol: "NYSE:O", finnhubSymbol: "O", name: "Realty Income Corp" },
            { symbol: "SPG", tvSymbol: "NYSE:SPG", finnhubSymbol: "SPG", name: "Simon Property Group" },
            { symbol: "AMT", tvSymbol: "NYSE:AMT", finnhubSymbol: "AMT", name: "American Tower Corp" },
        ]
    },
    finance: {
        name_he: "驻住 驻拽", name_en: "Finance & Fintech",
        icon: "<i class='fas fa-money-bill-transfer'></i>",
        isHot: false,
        stocks: [
            { symbol: "GS", tvSymbol: "NYSE:GS", finnhubSymbol: "GS", name: "Goldman Sachs Group" },
            { symbol: "JPM", tvSymbol: "NYSE:JPM", finnhubSymbol: "JPM", name: "JPMorgan Chase & Co." },
            { symbol: "V", tvSymbol: "NYSE:V", finnhubSymbol: "V", name: "Visa Inc." },
            { symbol: "PYPL", tvSymbol: "NASDAQ:PYPL", finnhubSymbol: "PYPL", name: "PayPal Holdings, Inc." },
        ]
    }
};

// Mock data for news sentiment counts, as Finnhub's basic news endpoint does not provide sentiment scores.
// Links will now go to Google News search for the stock.
const mockNewsSentimentData = {
    "NVDA": { positive: 18, negative: 3, neutral: 5 }, "AMD": { positive: 8, negative: 4, neutral: 3 }, "RBLX": { positive: 5, negative: 6, neutral: 2 }, "EA": { positive: 7, negative: 2, neutral: 4 }, "TTWO": { positive: 9, negative: 1, neutral: 3 },
    "GOOGL": { positive: 22, negative: 4, neutral: 6 }, "MSFT": { positive: 25, negative: 2, neutral: 8 }, "PLTR": { positive: 12, negative: 9, neutral: 4 }, "CRM": { positive: 6, negative: 5, neutral: 5 }, "SNOW": { positive: 4, negative: 7, neutral: 3 },
    "OKTA": { positive: 3, negative: 3, neutral: 6 }, "MRNA": { positive: 10, negative: 8, neutral: 4 }, "GILD": { positive: 5, negative: 6, neutral: 5 }, "VRTX": { positive: 11, negative: 2, neutral: 3 }, "CRWD": { positive: 15, negative: 3, neutral: 2 },
    "PANW": { positive: 12, negative: 2, neutral: 4 }, "FTNT": { positive: 7, negative: 4, neutral: 4 }, "AAPL": { positive: 19, negative: 5, neutral: 7 }, "META": { positive: 14, negative: 8, neutral: 5 }, "TSLA": { positive: 25, negative: 18, neutral: 10 },
    "NEE": { positive: 9, negative: 1, neutral: 6 }, "ICLN": { positive: 6, negative: 2, neutral: 3 }, "F": { positive: 7, negative: 5, neutral: 8 }, "GM": { positive: 9, negative: 4, neutral: 6 }, "ENPH": { positive: 12, negative: 3, neutral: 3 },
    "SEDG": { positive: 5, negative: 8, neutral: 4 }, "QS": { positive: 4, negative: 9, neutral: 2 }, "BE": { positive: 6, negative: 4, neutral: 3 }, "KO": { positive: 8, negative: 1, neutral: 7 }, "PEP": { positive: 9, negative: 2, neutral: 6 },
    "BYND": { positive: 3, negative: 10, neutral: 4 }, "AMZN": { positive: 20, negative: 3, neutral: 9 }, "BA": { positive: 6, negative: 15, neutral: 5 }, "LMT": { positive: 10, negative: 2, neutral: 4 }, "SPCE": { positive: 5, negative: 11, neutral: 3 },
    "BTCUSD": { positive: 30, negative: 15, neutral: 10 }, "ETHUSD": { positive: 28, negative: 12, neutral: 8 }, "SOLUSD": { positive: 18, negative: 20, neutral: 5 }, "XRPUSD": { positive: 15, negative: 15, neutral: 7 }, "ADAUSD": { positive: 12, negative: 10, neutral: 6 },
    "NFLX": { positive: 13, negative: 6, neutral: 5 }, "DIS": { positive: 10, negative: 8, neutral: 7 }, "CMCSA": { positive: 7, negative: 3, neutral: 8 }, "ISRG": { positive: 14, negative: 1, neutral: 2 }, "MDT": { positive: 9, negative: 3, neutral: 5 },
    "ABT": { positive: 11, negative: 2, neutral: 6 }, "O": { positive: 8, negative: 2, neutral: 9 }, "SPG": { positive: 6, negative: 4, neutral: 5 }, "AMT": { positive: 10, negative: 3, neutral: 4 }, "GS": { positive: 12, negative: 6, neutral: 6 },
    "JPM": { positive: 15, negative: 5, neutral: 8 }, "V": { positive: 18, negative: 2, neutral: 5 }, "PYPL": { positive: 9, negative: 11, neutral: 4 }
};

let selectedCategories = []; // Moved to global scope

/**
 * Fetches stock details using the proxy server.
 * @param {string} symbol The stock symbol.
 * @returns {Promise<object>} A promise that resolves with stock data or null on error.
 */
async function fetchStockDetails(symbol) {
    const now = Math.floor(Date.now() / 1000);
    const oneMonthAgo = now - (30 * 24 * 60 * 60);

    try {
        // Fetch candle data
        const candleResponse = await fetch(`${PROXY_BASE_URL}/stock/candle?symbol=${symbol}&resolution=D&from=${oneMonthAgo}&to=${now}`);
        if (!candleResponse.ok) {
            console.error(`Error fetching candle data for ${symbol} from proxy: ${candleResponse.status} ${candleResponse.statusText}`);
            // Attempt to read error body from proxy if available
            try {
                const errorBody = await candleResponse.json();
                console.error('Proxy candle error details:', errorBody);
            } catch (e) {
                console.error('Could not parse proxy candle error body:', e);
            }
            // If it's a 403, specifically log that the API key might be the issue
            if (candleResponse.status === 403) {
                console.error(`Finnhub API Key might be invalid or unauthorized for ${symbol}.`);
            }
            return null; // Indicate failure to use mock data
        }
        const candleData = await candleResponse.json();

        // Fetch profile data
        const profileResponse = await fetch(`${PROXY_BASE_URL}/stock/profile2?symbol=${symbol}`);
        if (!profileResponse.ok) {
            console.error(`Error fetching profile data for ${symbol} from proxy: ${profileResponse.status} ${profileResponse.statusText}`);
            // Attempt to read error body from proxy if available
            try {
                const errorBody = await profileResponse.json();
                console.error('Proxy profile error details:', errorBody);
            } catch (e) {
                console.error('Could not parse proxy profile error body:', e);
            }
            // If it's a 403, specifically log that the API key might be the issue
            if (profileResponse.status === 403) {
                console.error(`Finnhub API Key might be invalid or unauthorized for ${symbol}.`);
            }
            return null; // Indicate failure to use mock data
        }
        const profileData = await profileResponse.json();

        // Check if data is valid
        if (!candleData || !candleData.c || candleData.c.length === 0 || !profileData || Object.keys(profileData).length === 0) {
            console.warn(`Incomplete data for ${symbol}. Using mock data as fallback.`);
            return null; // Indicate failure to use mock data
        }

        const latestPrice = candleData.c[candleData.c.length - 1];
        const previousPrice = candleData.c[candleData.c.length - 2] || latestPrice; // Fallback for first day
        const change = latestPrice - previousPrice;
        const changePercent = (change / previousPrice * 100).toFixed(2);

        const formattedVolume = (profileData.shareOutstanding * latestPrice >= 1000000000000) ? `${(profileData.shareOutstanding * latestPrice / 1000000000000).toFixed(2)}T` :
                                (profileData.shareOutstanding * latestPrice >= 1000000000) ? `${(profileData.shareOutstanding * latestPrice / 1000000000).toFixed(2)}B` :
                                (profileData.shareOutstanding * latestPrice >= 1000000) ? `${(profileData.shareOutstanding * latestPrice / 1000000).toFixed(2)}M` :
                                (profileData.shareOutstanding * latestPrice).toFixed(2);

        return {
            name: profileData.name,
            price: latestPrice,
            change: `${change >= 0 ? '+' : ''}${changePercent}% (${change.toFixed(2)})`,
            volume: formattedVolume, // Using market cap as proxy for volume for simplicity
            marketCap: `${(profileData.marketCapitalization / 1000).toFixed(2)}B`, // Finnhub gives MarketCap in millions, convert to billions
            pe: profileData.peRatio ? profileData.peRatio.toFixed(1) : '-',
            rsi: (Math.random() * (70 - 30) + 30).toFixed(1), // Finnhub does not provide RSI directly, mock it
            sma50: (latestPrice * (1 + (Math.random() - 0.5) * 0.05)).toFixed(2), // Mock SMA
            sma200: (latestPrice * (1 + (Math.random() - 0.5) * 0.1)).toFixed(2), // Mock SMA
            support: (latestPrice * (1 - Math.random() * 0.03)).toFixed(2), // Mock Support
            resistance: (latestPrice * (1 + Math.random() * 0.03)).toFixed(2), // Mock Resistance
            historicalData: candleData.c // Use actual candle data for historical prices
        };

    } catch (error) {
        console.error(`Failed to fetch real data for ${symbol}:`, error);
        return null; // Indicate failure to use mock data
    }
}


/**
 * Generates mock stock details for a given symbol.
 * This function serves as a fallback when real API calls fail or are not used.
 * @param {string} symbol The stock symbol.
 * @param {string} stockName The stock's full name.
 * @returns {object} Mock stock data.
 */
function generateMockStockDetails(symbol, stockName) {
    const basePrice = Math.random() * 200 + 50; // Price between 50 and 250
    const changePercentNum = (Math.random() * 5 - 2.5); // Change between -2.5% and +2.5%
    const changePercent = changePercentNum.toFixed(2);
    const changeValue = (basePrice * (changePercentNum / 100)).toFixed(2);
    const volume = Math.floor(Math.random() * 1000 + 100) * 1000; // 100K to 1M
    const marketCap = Math.floor(Math.random() * 500 + 10) * 1000000; // 10M to 510M
    const peRatio = (Math.random() * 30 + 10).toFixed(1); // P/E between 10 and 40
    const rsiValue = (Math.random() * (70 - 30) + 30).toFixed(1); // RSI between 30 and 70
    const sma50 = (basePrice * (1 + (Math.random() - 0.5) * 0.05)).toFixed(2);
    const sma200 = (basePrice * (1 + (Math.random() - 0.5) * 0.1)).toFixed(2);
    const supportLevel = (basePrice * (1 - Math.random() * 0.03)).toFixed(2);
    const resistanceLevel = (basePrice * (1 + Math.random() * 0.03)).toFixed(2);

    const formattedVolume = (volume >= 1000000) ? `${(volume / 1000000).toFixed(1)}M` : (volume >= 1000) ? `${(volume / 1000).toFixed(1)}K` : volume.toString();
    let formattedMarketCap;
    if (marketCap >= 1000000000000) { // Trillions
        formattedMarketCap = `${(marketCap / 1000000000000).toFixed(2)}T`;
    } else if (marketCap >= 1000000000) { // Billions
        formattedMarketCap = `${(marketCap / 1000000000).toFixed(2)}B`;
    } else if (marketCap >= 1000000) { // Millions
        formattedMarketCap = `${(marketCap / 1000000).toFixed(2)}M`;
    } else {
        formattedMarketCap = marketCap.toString();
    }

    return {
        name: stockName || translations[currentLanguage].unknownStock,
        price: basePrice,
        change: `${changePercentNum >= 0 ? '+' : ''}${changePercent}% (${changeValue})`,
        volume: formattedVolume,
        marketCap: formattedMarketCap,
        pe: peRatio,
        rsi: rsiValue,
        sma50: sma50,
        sma200: sma200,
        support: supportLevel,
        resistance: resistanceLevel,
        historicalData: generateFakeHistory(basePrice, 30, basePrice * 0.015), // Generate 30 points of history
    };
}


/**
 * Function to determine news sentiment (mocked) and link to Google News
 * @param {string} stockSymbol The stock symbol.
 * @param {string} stockName The stock's full name.
 * @returns {object} Sentiment data and Google News links.
 */
function getNewsSentiment(stockSymbol, stockName) {
    const data = mockNewsSentimentData[stockSymbol] || { positive: Math.floor(Math.random()*10), negative: Math.floor(Math.random()*10), neutral: Math.floor(Math.random()*5) };
    
    let overallClass = 'neutral';
    let overallText = translations[currentLanguage].neutralSentiment;
    if (data.positive > data.negative * 1.2) { 
        overallClass = 'positive';
        overallText = translations[currentLanguage].positiveSentiment;
    } else if (data.negative > data.positive * 1.2) { 
        overallClass = 'negative';
        overallText = translations[currentLanguage].negativeSentiment;
    }
    
    return {
        ...data,
        overall: {
            class: overallClass,
            text: overallText,
        },
        // Links to Google News search for the stock name
        positiveLink: `https://www.google.com/search?q=${encodeURIComponent(stockName || stockSymbol)}+stock+news+positive&tbm=nws&hl=${currentLanguage}`,
        negativeLink: `https://www.google.com/search?q=${encodeURIComponent(stockName || stockSymbol)}+stock+news+negative&tbm=nws&hl=${currentLanguage}`,
        neutralLink: `https://www.google.com/search?q=${encodeURIComponent(stockName || stockSymbol)}+stock+news+neutral&tbm=nws&hl=${currentLanguage}`
    };
}

// Function to render category cards based on categoriesData order
function renderCategoryCards() {
    console.log('--- Debugging renderCategoryCards ---');
    console.log('Current language:', currentLanguage);
    console.log('Translations object:', translations);
    console.log('Value of translations[currentLanguage]:', translations[currentLanguage]); // Should be an object if currentLanguage is valid

    const categoriesGrid = document.getElementById('categoriesGrid');
    categoriesGrid.innerHTML = ''; // Clear existing cards

    // Iterate through the keys of categoriesData to maintain the defined order
    Object.keys(categoriesData).forEach((categoryKey, index) => {
        const category = categoriesData[categoryKey];
        const card = document.createElement('div');
        card.className = `category-card ${category.isHot ? 'hot' : ''}`;
        card.dataset.category = categoryKey;
        card.style.animationDelay = `${index * 0.1}s`; // Reapply animation delay

        const stocksHtml = category.stocks.map(stock => `<span class="stock-chip">${stock.symbol}</span>`).join('');

        // Add additional debugging logs here
        console.log(`Attempting to access for category ${categoryKey}:`);
        console.log(`  Title: ${categoryKey}Title -> ${translations[currentLanguage][`${categoryKey}Title`]}`);
        console.log(`  Desc: ${categoryKey}Desc -> ${translations[currentLanguage][`${categoryKey}Desc`]}`);
        console.log(`  Trend: ${categoryKey}Trend -> ${translations[currentLanguage][`${categoryKey}Trend`]}`);


        card.innerHTML = `
            <div class="category-header">
                <span class="category-icon">${category.icon}</span>
                <div class="category-title" data-key="${categoryKey}Title">${translations[currentLanguage][`${categoryKey}Title`]}</div>
            </div>
            <div class="category-description" data-key="${categoryKey}Desc">${translations[currentLanguage][`${categoryKey}Desc`]}</div>
            <div class="stocks-list">
                ${stocksHtml}
            </div>
            <div class="trend-info" data-key="${categoryKey}Trend">${translations[currentLanguage][`${categoryKey}Trend`]}</div>
        `;
        categoriesGrid.appendChild(card);

        // Add event listener to the newly created card
        card.addEventListener('click', function() {
            const category = this.dataset.category;
            
            // Toggle the 'selected' class
            this.classList.toggle('selected'); 

            if (this.classList.contains('selected')) {
                if (!selectedCategories.includes(category)) { // Prevent duplicates
                    selectedCategories.push(category);
                }
            } else {
                selectedCategories = selectedCategories.filter(cat => cat !== category);
            }
            updateSelectionSummary();
        });
    });
}

function updateSelectionSummary() {
    const countElement = document.getElementById('selectedCount');
    const continueBtn = document.getElementById('continueBtn');

    // Add animation class before updating text content
    countElement.classList.add('animate');
    countElement.textContent = selectedCategories.length.toString();
    console.log('Selected Categories:', selectedCategories); // ADDED LOG
    
    // Remove animation class after a short delay
    setTimeout(() => {
        countElement.classList.remove('animate');
    }, 300); // Match animation duration

    continueBtn.disabled = selectedCategories.length === 0;
}

// 驻拽爪转 注转 砖 砖驻专转
function displaySkeletonLoaders(container, count = 3, categoryKey) {
    const categoryName = categoriesData[categoryKey]?.[`name_${currentLanguage}`] || translations[currentLanguage].loadingCategory;

    const sectorDiv = document.createElement('div');
    sectorDiv.className = 'selected-sectors'; // Use the existing class for structure
    // Removed direct style manipulation here, relying on CSS animation
    // sectorDiv.style.opacity = '0'; 
    // sectorDiv.style.transform = 'translateY(20px)';
    sectorDiv.style.animation = 'sectionFadeIn 0.8s ease-out forwards'; // Apply animation

    const sectorTitle = document.createElement('div');
    sectorTitle.className = 'sector-title';
    sectorTitle.innerHTML = ` ${categoryName} <span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>`; // Add loading dots
    
    const stocksGrid = document.createElement('div');
    stocksGrid.className = 'stocks-grid';

    let skeletonHTML = '';
    for (let i = 0; i < count; i++) {
        skeletonHTML += `
            <div class="skeleton-card">
                <div class="skeleton-header-top">
                    <div>
                        <div class="skeleton-item skeleton-symbol-name"></div>
                        <div class="skeleton-item skeleton-name-small"></div>
                    </div>
                    <div class="skeleton-item skeleton-price-area"></div>
                </div>
                <div class="skeleton-details-grid">
                    <div class="skeleton-item skeleton-detail-item"></div><div class="skeleton-item skeleton-detail-item"></div>
                    <div class="skeleton-item skeleton-detail-item"></div><div class="skeleton-item skeleton-detail-item"></div>
                </div>
                
                <div class="skeleton-item skeleton-tech-title"></div>
                <div class="skeleton-tech-grid">
                    <div class="skeleton-item skeleton-tech-item"></div><div class="skeleton-item skeleton-tech-item"></div>
                    <div class="skeleton-item skeleton-tech-item"></div><div class="skeleton-item skeleton-tech-item"></div>
                </div>
                
                <div class="skeleton-item skeleton-news-title"></div>
                <div class="skeleton-news-grid">
                    <div class="skeleton-item skeleton-news-item"></div>
                    <div class="skeleton-item skeleton-news-item"></div>
                    <div class="skeleton-item skeleton-news-item"></div>
                </div>
                <div class="skeleton-item skeleton-overall-sentiment"></div>
                
                <div class="skeleton-item skeleton-chart-title"></div>
                <div class="skeleton-item skeleton-chart-doughnut"></div>
                <div class="skeleton-item skeleton-chart-title"></div>
                <div class="skeleton-item skeleton-chart-line"></div>
            </div>
        `;
    }
    stocksGrid.innerHTML = skeletonHTML;
    
    sectorDiv.appendChild(sectorTitle);
    sectorDiv.appendChild(stocksGrid);
    container.appendChild(sectorDiv);

    // Add loading dots animation style
    if (!document.getElementById('loading-dots-style')) {
        const loadingDotsStyle = document.createElement('style');
        loadingDotsStyle.id = 'loading-dots-style';
        loadingDotsStyle.innerHTML = `
            .loading-dots span {
                animation: blink 1.4s infinite linear;
            }
            .loading-dots span:nth-child(2) {
                animation-delay: 0.2s;
            }
            .loading-dots span:nth-child(3) {
                animation-delay: 0.4s;
            }
            @keyframes blink {
                0%, 100% { opacity: 0; }
                50% { opacity: 1; }
            }
        `;
        document.head.appendChild(loadingDotsStyle);
    }
}

function renderTradingViewWidget(categories) {
    console.log("renderTradingViewWidget called with categories:", categories);
    const container = document.getElementById('tv-market-overview-widget-container');
    if (!container) {
        console.error("TradingView widget container not found.");
        return;
    }

    // Clear any previous widget instances
    container.innerHTML = '';

    const tabs = categories.map(key => {
        const category = categoriesData[key];
        return {
            title: category[`name_${currentLanguage}`] || category.name_he,
            symbols: category.stocks.map(stock => ({
                s: stock.tvSymbol,
                d: stock.name
            }))
        };
    });

    // If no categories are selected, show a default tab.
    if (tabs.length === 0) {
        tabs.push({
            title: translations[currentLanguage].noCategoriesSelected || "No Categories Selected",
            symbols: [
                { s: "FOREXCOM:SPXUSD", d: "S&P 500" },
                { s: "FOREXCOM:NSXUSD", d: "NASDAQ 100" },
                { s: "FOREXCOM:DJI", d: "Dow Jones" }
            ]
        });
    }

    const widgetConfigObject = {
        "colorTheme": savedTheme,
        "dateRange": "12M",
        "showChart": true,
        "locale": currentLanguage === 'he' ? 'he_IL' : 'en',
        "largeChartUrl": "",
        "isTransparent": false,
        "showSymbolLogo": true,
        "width": "100%",
        "height": "100%",
        "tabs": tabs,
        "container_id": "tv-market-overview-widget-container" // This is important for the widget to attach
    };

    console.log("Generated widgetConfigObject:", widgetConfigObject);

    // Create the inner div for the widget
    const widgetDiv = document.createElement('div');
    widgetDiv.className = 'tradingview-widget-container__widget';

    // Create the copyright div
    const copyrightDiv = document.createElement('div');
    copyrightDiv.className = 'tradingview-widget-copyright';
    copyrightDiv.innerHTML = `
        <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
            <span class="blue-text" data-key="followMarketsTradingView">${translations[currentLanguage].followMarketsTradingView}</span>
        </a>
    `;

    // Create the script tag for the widget configuration
    const scriptTag = document.createElement('script');
    scriptTag.type = 'text/javascript';
    scriptTag.src = 'https://s3.tradingview.com/external-embedding/embed-widget-market-overview.js';
    scriptTag.async = true; // Keep async for this dynamically loaded script
    scriptTag.innerHTML = JSON.stringify(widgetConfigObject);

    // Append elements to the main container
    container.appendChild(widgetDiv);
    container.appendChild(copyrightDiv);
    container.appendChild(scriptTag);
}

// Global object to store Chart.js instances for destruction
window.myCharts = window.myCharts || {};

async function goToAnalysis(isLanguageChange = false) { // Added parameter
    console.log('goToAnalysis called. selectedCategories:', selectedCategories); // ADDED LOG
    if (selectedCategories.length === 0 && !isLanguageChange) {
        console.warn('No categories selected. Aborting analysis page load.'); // ADDED LOG
        return; // Only block if not a language change re-render
    }

    document.getElementById('selectionPage').classList.remove('active');
    document.getElementById('analysisPage').classList.add('active');

    // Render dynamic TradingView widget
    renderTradingViewWidget(selectedCategories);

    const container = document.getElementById('selectedSectorsContainer');
    container.innerHTML = '';

    // Display skeletons first for each selected category
    selectedCategories.forEach(key => {
        const cat = categoriesData[key];
        if (cat) {
            displaySkeletonLoaders(container, cat.stocks.length, key); // Pass key for localized name
        } else {
            console.warn(`Category data not found for key: ${key}`); // ADDED LOG
        }
    });

    window.scrollTo(0, 0);

    // Prepare promises for fetching stock data
    const stocksToProcess = [];
    selectedCategories.forEach(key => {
        if (categoriesData[key]) {
            categoriesData[key].stocks.forEach(stock => {
                stocksToProcess.push({ categoryKey: key, stock });
            });
        }
    });
    console.log('Stocks to process:', stocksToProcess); // ADDED LOG

    const fetchDataPromises = stocksToProcess.map(async ({ categoryKey: catKey, stock }) => { 
        let fetchedData = null;
        // Attempt to fetch real data from proxy
        if (!stock.isCrypto) { // Only attempt proxy for non-crypto stocks
            fetchedData = await fetchStockDetails(stock.finnhubSymbol);
        }
        
        // If real data fetch fails or it's a crypto stock, use mock data
        if (!fetchedData) {
            fetchedData = generateMockStockDetails(stock.symbol, stock.name);
            console.log(`Using mock data for ${stock.symbol}:`, fetchedData); // ADDED LOG
        }
        
        // Always get news sentiment (mocked)
        fetchedData.newsSentiment = getNewsSentiment(stock.symbol, fetchedData.name || stock.name);
        
        return { categoryKey: catKey, stock: { ...stock, ...fetchedData } };
    });

    try {
        const allProcessedStocks = await Promise.all(fetchDataPromises);
        console.log('All processed stocks (after fetch/mock):', allProcessedStocks); // ADDED LOG

        const dataToRender = {};
        allProcessedStocks.forEach(item => { // Iterate over 'item'
            // Ensure item and item.categoryKey are defined
            if (!item || typeof item.categoryKey !== 'string' || item.categoryKey.length === 0) {
                console.error('Skipping malformed processed stock item due to invalid categoryKey:', item);
                return; // Skip if item or its categoryKey is missing or invalid
            }
            const categoryKey = item.categoryKey; // Explicitly extract categoryKey
            const stock = item.stock;

            if (!dataToRender[categoryKey]) {
                dataToRender[categoryKey] = {
                    // Ensure categoriesData[categoryKey] exists before spreading, fallback to empty object
                    ...(categoriesData[categoryKey] || {}), 
                    stocks: []
                };
            }
            dataToRender[categoryKey].stocks.push(stock);
        });
        console.log('Data to render (grouped by category):', dataToRender); // ADDED LOG

        // Add a small delay before generating analysis to allow skeleton loaders to be seen
        setTimeout(() => {
            generateAnalysis(dataToRender);
        }, 1000); // Adjust delay as needed for better UX
        
    } catch (error) {
        console.error("Failed to fetch or generate analysis:", error);
        container.innerHTML = `<div class="selected-sectors" style="text-align:center;"><p style="color: #ef4444; font-weight: bold; padding: 20px;">${translations[currentLanguage].errorLoadingData}</p></div>`;
    }
}

function goBackToSelection() {
    document.getElementById('analysisPage').classList.remove('active');
    document.getElementById('selectionPage').classList.add('active');
    // Clear the dynamic widget when going back
    const tvContainer = document.getElementById('tv-market-overview-widget-container');
    // It's generally better to hide the widget or let it manage its own lifecycle
    // rather than clearing its innerHTML if it's a persistent widget.
    // For TradingView, simply setting display: none on its parent might be enough.
    // Given the previous issue, we'll leave this line for now, but it's a point to watch.
    if (tvContainer) tvContainer.innerHTML = ''; 
    window.scrollTo(0, 0); 
}

/**
 * Fetches an AI-generated insight for a given stock using the Gemini API.
 * Returns a mock insight if the API call fails or returns a 403.
 * @param {object} stock The stock object with its data.
 * @returns {Promise<string>} A promise that resolves with the AI insight text or a mock message.
 */
async function fetchAIInsight(stock) {
    const mockInsight = currentLanguage === 'he' ? 
        `转转 AI : 注 住住 转 , 转 ${stock.name || stock.symbol} 爪  注转. 砖 爪注 拽专 住祝 驻  转 砖拽注.` :
        `Mock AI Insight: Based on available data, ${stock.name || stock.symbol} stock shows an interesting trend. Further research is recommended before any investment decision.`;

    try {
        const prompt = `Based on the following data for stock ${stock.name || stock.symbol}:
- Positive sentiment: ${stock.newsSentiment.positive} articles
- Negative sentiment: ${stock.newsSentiment.negative} articles
- Neutral sentiment: ${stock.newsSentiment.neutral} articles
- Last price: $${stock.price !== undefined && typeof stock.price === 'number' ? stock.price.toFixed(2) : 'N/A'}
- Change: ${stock.change || 'N/A'}
- Market Cap: ${stock.marketCap || 'N/A'}
- RSI: ${stock.rsi || 'N/A'}

Provide a concise insight (2-3 sentences) on the investment potential or current trend of the stock. Use simple, user-friendly language. Respond in ${currentLanguage === 'he' ? 'Hebrew' : 'English'}.`;

        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        const payload = { contents: chatHistory };
        const apiKey = "AIzaSyA3FKwQiDwiODm2z7tmPUblC2ZGTmYy5v4"; // Canvas environment will inject the API key here
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            console.error(`Gemini API returned an error: ${response.status} ${response.statusText}`);
            // Attempt to read error body if available
            try {
                const errorBody = await response.json();
                console.error('Gemini API error details:', errorBody);
            } catch (e) {
                console.error('Could not parse Gemini API error body:', e);
            }
            return mockInsight; // Return mock insight on API error
        }

        const result = await response.json();

        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
            return result.candidates[0].content.parts[0].text;
        } else {
            console.error('Unexpected API response structure:', result);
            return mockInsight; // Return mock insight on unexpected structure
        }
    } catch (error) {
        console.error(`Error fetching AI insight for ${stock.symbol}:`, error);
        return mockInsight; // Return mock insight on network or other errors
    }
}


function generateAnalysis(dataToRender) {
    const selectedSectorsContainerDiv = document.getElementById('selectedSectorsContainer');
    selectedSectorsContainerDiv.innerHTML = ''; // Clear skeletons
    
    console.log('generateAnalysis: dataToRender at start', dataToRender);
    
    if (!dataToRender || typeof dataToRender !== 'object' || Object.keys(dataToRender).length === 0) {
         selectedSectorsContainerDiv.innerHTML = `<p style="text-align:center; padding: 20px; color: var(--text-color-secondary);">${translations[currentLanguage].noCategoriesSelected}</p>`;
         return;
    }

    // Store stock objects with their generated HTML element IDs
    const allStocksForChartsInit = [];

    // Iterate over the keys of dataToRender. Ensure `categoryKey` is always a string.
    Object.keys(dataToRender).forEach(function(key) {
        const categoryKey = (typeof key === 'string' && key.length > 0) ? key : 'unknown-category';
        const categoryData = dataToRender[categoryKey];
        
        if (!categoryData || !categoryData.stocks || !Array.isArray(categoryData.stocks)) {
            console.warn(`Skipping category ${categoryKey} due to missing or invalid stock data.`, categoryData);
            return; 
        }

        console.log('generateAnalysis: Processing categoryKey', categoryKey, 'with data:', categoryData);

        const sectorDiv = document.createElement('div');
        sectorDiv.className = 'selected-sectors'; 
        
        let stocksHtml = '';
        categoryData.stocks.forEach(stock => {
            // ADDED LOG TO SEE THE FINAL STOCK OBJECT BEFORE RENDERING
            console.log(`Rendering stock ${stock.symbol} in category ${categoryKey} with data:`, stock); 

            try {
                if (!stock || typeof stock !== 'object') {
                    console.warn('Skipping malformed stock object:', stock);
                    stocksHtml += `<div class="stock-card" style="text-align:center; color: #ef4444; padding: 20px;">${translations[currentLanguage].stockDataError}</div>`;
                    return;
                }

                const stockSymbol = (typeof stock.symbol === 'string' && stock.symbol.length > 0) ? stock.symbol : 'UNKNOWN_SYMBOL';
                const stockName = (typeof stock.name === 'string' && stock.name.length > 0) ? stock.name : translations[currentLanguage].unknownStock;

                const currentPrice = stock.price !== undefined ? Number(stock.price) : 0;
                const changeStr = stock.change !== undefined ? stock.change : "0%";
                const isPositive = changeStr.includes('+');
                const changeClass = isPositive ? 'positive' : (!changeStr.includes('-') || parseFloat(changeStr) === 0 ? '' : 'negative');
                
                const sentimentData = stock.newsSentiment || { positive: 0, negative: 0, neutral: 0, overall: { class: 'neutral', text: translations[currentLanguage].neutralSentiment }, positiveLink: '#', negativeLink: '#', 'neutralLink': '#' };

                // Generate unique IDs for charts and AI insight container
                const uniqueSuffix = `${stockSymbol.replace(/[^a-zA-Z0-9]/g, '')}-${categoryKey}-${Math.random().toString(36).substring(2, 7)}`;
                const sentimentChartId = `sentimentChart-${uniqueSuffix}`;
                const lineChartId = `lineChart-${uniqueSuffix}`;
                const aiInsightId = `aiInsight-${uniqueSuffix}`;
                
                // Store the generated IDs on the stock object itself for later retrieval
                stock.generatedSentimentChartId = sentimentChartId;
                stock.generatedLineChartId = lineChartId;
                stock.generatedAiInsightId = aiInsightId; // Store AI insight ID
                
                allStocksForChartsInit.push(stock); // Add to a global array for chart initialization

                const sentimentAriaLabel = `${translations[currentLanguage].overallSentimentAnalysis} ${stockSymbol}: ${sentimentData.positive}% ${translations[currentLanguage].positiveSentiment}, ${sentimentData.negative}% ${translations[currentLanguage].negativeSentiment}, ${sentimentData.neutral}% ${translations[currentLanguage].neutralSentiment}`;
                const lineChartAriaLabel = `${translations[currentLanguage].stockPerformance30Days} ${stockName}.`;
                
                stocksHtml += `
                    <div class="stock-card">
                        <div class="stock-header">
                            <div>
                                <div class="stock-symbol">${stockSymbol}</div>
                                <div class="stock-name">${stockName}</div>
                            </div>
                            <div>
                                <div class="stock-price ${changeClass}">$${currentPrice.toFixed(2)}</div>
                                <div class="market-change ${changeClass}">${changeStr}</div>
                            </div>
                        </div>
                        
                        <div class="stock-details">
                            <div class="stock-detail"><span class="detail-label">${translations[currentLanguage].volume}</span><span class="detail-value">${stock.volume || '-'}</span></div>
                            <div class="stock-detail"><span class="detail-label">${translations[currentLanguage].marketCap}</span><span class="detail-value">${stock.marketCap || '-'}</span></div>
                            <div class="stock-detail"><span class="detail-label">${translations[currentLanguage].pe}</span><span class="detail-value">${stock.pe || '-'}</span></div>
                            <div class="stock-detail"><span class="detail-label">${translations[currentLanguage].rsi}</span><span class="detail-value">${stock.rsi ? Number(stock.rsi).toFixed(1) : '-'}</span></div>
                        </div>
                        
                        <div class="technical-analysis">
                            <div class="technical-title">${translations[currentLanguage].technicalAnalysis}</div>
                            <div class="technical-grid">
                                <div class="stock-detail"><span class="detail-label">${translations[currentLanguage].sma50}</span><span class="detail-value">$${stock.sma50 ? Number(stock.sma50).toFixed(2) : '-'}</span></div>
                                <div class="stock-detail"><span class="detail-label">${translations[currentLanguage].sma200}</span><span class="detail-value">$${stock.sma200 ? Number(stock.sma200).toFixed(2) : '-'}</span></div>
                                <div class="stock-detail"><span class="detail-label">${translations[currentLanguage].support}</span><span class="detail-value">$${stock.support ? Number(stock.support).toFixed(2) : '-'}</span></div>
                                <div class="stock-detail"><span class="detail-label">${translations[currentLanguage].resistance}</span><span class="detail-value">$${stock.resistance ? Number(stock.resistance).toFixed(2) : '-'}</span></div>
                            </div>
                        </div>
                        
                        <div class="news-sentiment-analysis">
                            <div class="technical-title">${translations[currentLanguage].newsAnalysis}</div>
                            <div class="news-sentiment-grid">
                                <a href="${sentimentData.positiveLink}" target="_blank" rel="noopener noreferrer" class="sentiment-link" aria-label="${translations[currentLanguage].positiveArticles} ${stockSymbol}">
                                    <div class="sentiment-detail">
                                        <span class="sentiment-icon"><i class="far fa-smile"></i></span>
                                        <span class="detail-label">${translations[currentLanguage].positiveArticles}</span>
                                        <span class="detail-value">${sentimentData.positive}</span>
                                    </div>
                                </a>
                                <a href="${sentimentData.negativeLink}" target="_blank" rel="noopener noreferrer" class="sentiment-link" aria-label="${translations[currentLanguage].negativeArticles} ${stockSymbol}">
                                    <div class="sentiment-detail">
                                        <span class="sentiment-icon"><i class="far fa-frown"></i></span>
                                        <span class="detail-label">${translations[currentLanguage].negativeArticles}</span>
                                        <span class="detail-value">${sentimentData.negative}</span>
                                    </div>
                                </a>
                                <a href="${sentimentData.neutralLink}" target="_blank" rel="noopener noreferrer" class="sentiment-link" aria-label="${translations[currentLanguage].neutralArticles} ${stockSymbol}">
                                    <div class="sentiment-detail">
                                        <span class="sentiment-icon"><i class="far fa-meh"></i></span>
                                        <span class="detail-label">${translations[currentLanguage].neutralArticles}</span>
                                        <span class="detail-value">${sentimentData.neutral}</span>
                                    </div>
                                </a>
                            </div>
                            <div class="overall-sentiment">
                                <span class="detail-label">${translations[currentLanguage].overallSentiment}</span>
                                <span class="sentiment-badge ${sentimentData.overall.class}">${sentimentData.overall.text}</span>
                            </div>
                        </div>
                        
                        <div class="sentiment-analysis">
                            <div class="sentiment-title-container">
                                <div class="sentiment-title">${translations[currentLanguage].overallSentimentAnalysis}</div>
                                <span class="info-icon" aria-label="${translations[currentLanguage].sentimentInfoTitle}"></span>
                                <div class="info-tooltip">
                                    <p>${translations[currentLanguage].sentimentInfoPositive}</p>
                                    <p>${translations[currentLanguage].sentimentInfoNegative}</p>
                                    <p>${translations[currentLanguage].sentimentInfoNeutral}</p>
                                </div>
                            </div>
                            <div class="chart-container"><canvas id="${sentimentChartId}" role="img" aria-label="${sentimentAriaLabel}"></canvas></div>
                        </div>

                        <!-- AI Insight Section - NEW -->
                        <div id="${aiInsightId}" class="ai-insight">
                            <strong><i class="fas fa-robot"></i> ${translations[currentLanguage].aiInsight}</strong>
                            <span class="loading-dots"><span>.</span><span>.</span><span>.</span> ${translations[currentLanguage].loadingInsight}</span>
                        </div>

                        <div class="sentiment-title" style="margin-top:20px;">${translations[currentLanguage].stockPerformance30Days}</div>
                        <div class="line-chart-container"><canvas id="${lineChartId}" role="img" aria-label="${lineChartAriaLabel}"></canvas></div>
                    </div>
                `;
            } catch (e) {
                console.error(`Error generating HTML for stock: ${stock?.symbol || 'Unknown'} in category: ${categoryKey}. Error:`, e);
                stocksHtml += `<div class="stock-card" style="text-align:center; color: #ef4444; padding: 20px;">${translations[currentLanguage].errorLoadingData} ${stock?.symbol || 'Unknown'}.</div>`;
            }
        });
        
        sectorDiv.innerHTML = `
            <div class="sector-title">${categoryData.icon || ''} ${categoryData[`name_${currentLanguage}`] || categoryData.name_he}</div>
            <div class="stocks-grid">${stocksHtml}</div>
        `;
        selectedSectorsContainerDiv.appendChild(sectorDiv);

        // Initialize charts and fetch AI insights after HTML is added to DOM
        // Use the global array `allStocksForChartsInit` which holds the stock objects
        // with their pre-generated unique IDs.
        allStocksForChartsInit.forEach(stock => {
            try {
                // Retrieve the pre-generated unique IDs from the stock object
                const sentimentChartIdForCanvas = stock.generatedSentimentChartId;
                const lineChartIdForCanvas = stock.generatedLineChartId;
                const aiInsightIdForDiv = stock.generatedAiInsightId;

                const sentimentChartCanvasEl = document.getElementById(sentimentChartIdForCanvas);
                const lineChartCanvasEl = document.getElementById(lineChartIdForCanvas);
                const aiInsightDiv = document.getElementById(aiInsightIdForDiv);

                const sentimentData = stock.newsSentiment || { positive: 0, negative: 0, neutral: 0 }; 
                
                // Destroy existing chart instances if they exist
                if (window.myCharts[sentimentChartIdForCanvas]) {
                    window.myCharts[sentimentChartIdForCanvas].destroy();
                }
                if (window.myCharts[lineChartIdForCanvas]) {
                    window.myCharts[lineChartIdForCanvas].destroy();
                }

                if (sentimentChartCanvasEl) {
                    window.myCharts[sentimentChartIdForCanvas] = new Chart(sentimentChartCanvasEl.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: [translations[currentLanguage].positiveSentiment, translations[currentLanguage].negativeSentiment, translations[currentLanguage].neutralSentiment],
                            datasets: [{
                                label: translations[currentLanguage].overallSentimentAnalysis,
                                data: [sentimentData.positive, sentimentData.negative, sentimentData.neutral],
                                backgroundColor: ['rgba(16, 185, 129, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(107, 114, 128, 0.7)'],
                                borderColor: ['#fff'], borderWidth: 2
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15, color: 'var(--text-color-secondary)' }}, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.parsed}%` }}}}
                    });
                }

                if (lineChartCanvasEl && stock.historicalData && stock.historicalData.length > 0) {
                    window.myCharts[lineChartIdForCanvas] = new Chart(lineChartCanvasEl.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: stock.historicalData.length}, (_, i) => `${i + 1}`),
                            datasets: [{
                                label: translations[currentLanguage].price,
                                data: stock.historicalData,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2, pointRadius: 0, tension: 0.1, fill: true
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { y: { beginAtZero: false }, x: { ticks: { autoSkip: true, maxTicksLimit: 8 }}},
                            plugins: { legend: { display: false }, tooltip: { callbacks: { title: (items) => `${translations[currentLanguage].priceOnDay} ${items[0].label}`, label: (c) => `${translations[currentLanguage].price}: $${Number(c.parsed.y).toFixed(2)}`}}}
                        }
                    });
                }

                // Fetch AI Insight for the stock
                if (aiInsightDiv) {
                    aiInsightDiv.innerHTML = `<strong><i class="fas fa-robot"></i> ${translations[currentLanguage].aiInsight}</strong> <span class="loading-dots"><span>.</span><span>.</span><span>.</span> ${translations[currentLanguage].loadingInsight}</span>`;
                    fetchAIInsight(stock).then(insightText => {
                        aiInsightDiv.innerHTML = `<strong><i class="fas fa-robot"></i> ${translations[currentLanguage].aiInsight}</strong> ${insightText}`;
                    }).catch(e => {
                        console.error(`Failed to load AI insight for ${stock.symbol}:`, e);
                        aiInsightDiv.innerHTML = `<strong><i class="fas fa-robot"></i> ${translations[currentLanguage].aiInsight}</strong> ${translations[currentLanguage].errorLoadingInsight}`;
                    });
                }

            } catch (e) {
                console.error(`Error initializing chart/AI for stock: ${stock?.symbol || 'Unknown'} in category: ${categoryKey}. Error:`, e);
            }
        });
    });
}

document.addEventListener('DOMContentLoaded', () => {
    const loginPage = document.getElementById('loginPage');
    const startButton = document.getElementById('startButton');
    const usernameInput = document.getElementById('usernameInput');
    const mainContainer = document.querySelector('.container');
    const bodyContainer = document.querySelector('.body-container');
    const continueBtn = document.getElementById('continueBtn');
    const backBtn = document.getElementById('backBtn');

    const lightModeBtn = document.getElementById('lightModeBtn');
    const darkModeBtn = document.getElementById('darkModeBtn');

    // --- Theme Logic ---
    function setTheme(mode) {
        if (mode === 'dark') {
            document.body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark');
            darkModeBtn.classList.add('active');
            lightModeBtn.classList.remove('active');
        } else {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('theme', 'light');
            lightModeBtn.classList.add('active');
            darkModeBtn.classList.remove('active');
        }
    }

    // Apply saved theme on load (now defined globally)
    setTheme(savedTheme);

    lightModeBtn.addEventListener('click', () => setTheme('light'));
    darkModeBtn.addEventListener('click', () => setTheme('dark'));
    // --- End Theme Logic ---

    // --- Language Logic ---
    // Set initial language and add event listeners
    // Call setLanguage AFTER translations object is fully defined and DOM is ready
    const storedLang = localStorage.getItem('selectedLanguage');
    setLanguage(storedLang || 'he'); // Default to Hebrew

    document.getElementById('lang-he').addEventListener('click', () => {
        setLanguage('he');
        localStorage.setItem('selectedLanguage', 'he');
    });
    document.getElementById('lang-en').addEventListener('click', () => {
        setLanguage('en');
        localStorage.setItem('selectedLanguage', 'en');
    });
    // --- End Language Logic ---


    function startApp() {
        const username = usernameInput.value.trim();
        if (username) {
            // Update welcome text with username and current date/time greeting
            updateDynamicText(); // Call to update the greeting based on currentLanguage

            loginPage.style.opacity = '0';
            setTimeout(() => {
                loginPage.style.display = 'none';
                if(bodyContainer) bodyContainer.style.display = 'block';
                if(mainContainer) mainContainer.style.display = 'block';
                if(mainContainer) mainContainer.style.animation = 'fadeIn 0.5s ease-in-out';

                // Trigger card appear animation on categories grid
                document.querySelectorAll('.category-card').forEach((card) => {
                    card.style.animationName = 'cardAppear';
                });

            }, 500); // Match CSS transition duration
        } else {
            usernameInput.style.borderColor = '#ef4444';
            usernameInput.focus();
            // 住驻转 爪转 注专 拽 砖 拽 砖
            usernameInput.classList.add('shake');
            setTimeout(() => {
                usernameInput.style.borderColor = 'var(--input-border)'; /* Use variable for reset */
                usernameInput.classList.remove('shake');
            }, 800); /*  拽爪专 转专 转砖砖转 爪转 注专 */
        }
    }
    // 爪转 注专 砖 拽
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }\
        .shake {
            animation: shake 0.3s ease-in-out;
        }
    `;
    document.head.appendChild(style);


    startButton.addEventListener('click', startApp);
    usernameInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
            startApp();
        }
    });
    
    continueBtn.addEventListener('click', () => goToAnalysis(false));
    backBtn.addEventListener('click', goBackToSelection);

    // Initial render of category cards when the DOM is loaded
    // REMOVED: renderCategoryCards(); // This call is now handled by setLanguage
});
    </script>
</body>
</html>
